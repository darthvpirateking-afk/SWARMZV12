<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUSMON // ORGANISM COCKPIT âš¡ðŸŸ¢</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap');

:root {
  --bg:      #03050a;
  --panel:   #060a10;
  --card:    #080d16;
  --border:  #0c1520;
  --bh:      #142030;
  --text:    #7aaac0;
  --dim:     #253545;
  --bright:  #c0e0f0;
  --accent:  #00ccff;
  --a2:      #005580;
  --green:   #00ff88;
  --amber:   #ffaa00;
  --red:     #ff3355;
  --purple:  #aa55ff;
  --mono:    'Share Tech Mono', monospace;
  --head:    'Rajdhani', sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  min-height: 100vh;
}

body::after {
  content: '';
  position: fixed; inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,180,255,0.012) 3px, rgba(0,180,255,0.012) 4px);
  pointer-events: none;
  z-index: 9999;
}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; height: 52px;
  border-bottom: 1px solid var(--bh);
  background: var(--panel);
  position: sticky; top: 0; z-index: 200;
}

.logo {
  font-family: var(--head); font-size: 22px; font-weight: 700;
  letter-spacing: 0.2em; color: var(--bright);
}
.logo em { color: var(--accent); font-style: normal; }
.logo-sub { font-size: 10px; letter-spacing: 0.15em; color: var(--dim); margin-left: 12px; vertical-align: middle; }

.topbar-right { display: flex; align-items: center; gap: 16px; }

.stage-badge {
  font-family: var(--head); font-size: 13px; font-weight: 600;
  letter-spacing: 0.12em; padding: 4px 14px;
  border: 1px solid currentColor; border-radius: 2px;
  transition: all 0.4s;
}

.clock { font-size: 11px; color: var(--dim); letter-spacing: 0.08em; }
.last-updated { font-size: 9px; color: var(--dim); letter-spacing: 0.06em; }

.refresh-btn {
  background: none; border: 1px solid var(--bh); border-radius: 2px;
  color: var(--dim); font-family: var(--mono); font-size: 10px;
  letter-spacing: 0.1em; padding: 5px 12px; cursor: pointer;
  transition: all 0.2s;
}
.refresh-btn:hover { border-color: var(--accent); color: var(--accent); }

/* â”€â”€ LAYOUT â”€â”€ */
.shell {
  display: grid;
  grid-template-columns: 220px 1fr 280px;
  grid-template-rows: auto 1fr;
  min-height: calc(100vh - 52px);
  gap: 0;
}

/* â”€â”€ LEFT SIDEBAR â”€â”€ */
.sidebar-left {
  border-right: 1px solid var(--border);
  border-left: 3px solid var(--dim);
  display: flex; flex-direction: column;
  background: var(--panel);
  transition: border-left-color 0.4s;
}

.side-section { padding: 16px; border-bottom: 1px solid var(--border); }

.side-label {
  font-size: 9px; letter-spacing: 0.18em; text-transform: uppercase;
  color: var(--dim); margin-bottom: 12px;
}

/* Evolution stage display */
.evo-stage {
  text-align: center; padding: 12px 0;
}
.evo-stage-name {
  font-family: var(--head); font-size: 28px; font-weight: 700;
  letter-spacing: 0.1em; transition: color 0.4s;
  line-height: 1;
}
.evo-rank-dots {
  display: flex; justify-content: center; gap: 6px; margin: 10px 0 8px;
}
.rank-dot {
  width: 8px; height: 8px; border-radius: 50%;
  border: 1px solid var(--bh);
  transition: all 0.4s;
}
.rank-dot.filled { border-color: var(--accent); background: var(--accent); box-shadow: 0 0 6px var(--accent); }

.xp-row { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
.xp-label { font-size: 9px; color: var(--dim); letter-spacing: 0.1em; }
.xp-val { font-size: 11px; color: var(--accent); }
.xp-bar { flex: 1; height: 2px; background: var(--border); border-radius: 1px; overflow: hidden; }
.xp-fill { height: 100%; background: var(--accent); box-shadow: 0 0 4px var(--accent); transition: width 0.6s ease; }

/* Traits list */
.trait-list { display: flex; flex-direction: column; gap: 6px; }
.trait-item {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 8px; border-radius: 2px;
  border: 1px solid var(--border);
  background: var(--card);
  transition: all 0.2s;
}
.trait-item:hover { border-color: var(--bh); }
.trait-dot {
  width: 5px; height: 5px; border-radius: 50%;
  flex-shrink: 0;
}
.trait-name { font-size: 10px; letter-spacing: 0.06em; color: var(--bright); }
.trait-cat { font-size: 9px; color: var(--dim); margin-left: auto; }

.cat-COGNITIVE { background: var(--accent); box-shadow: 0 0 4px var(--accent); }
.cat-RESONANCE { background: var(--purple); box-shadow: 0 0 4px var(--purple); }
.cat-TACTICAL  { background: var(--amber); box-shadow: 0 0 4px var(--amber); }
.cat-ADAPTIVE  { background: var(--green); box-shadow: 0 0 4px var(--green); }

/* Next stage */
.next-stage-box {
  font-size: 10px; color: var(--dim);
  padding: 8px; border: 1px dashed var(--border); border-radius: 2px;
}
.next-stage-name { color: var(--text); letter-spacing: 0.08em; margin-bottom: 4px; }
.next-req { display: flex; justify-content: space-between; margin-top: 3px; }

/* â”€â”€ MAIN AREA â”€â”€ */
.main {
  overflow-y: auto;
  display: flex; flex-direction: column;
  gap: 0;
}

/* Tab nav */
.tab-nav {
  display: flex; border-bottom: 1px solid var(--border);
  background: var(--panel); position: sticky; top: 0; z-index: 100;
  overflow-x: auto;
}
.tab-btn {
  padding: 12px 18px; font-family: var(--mono); font-size: 10px;
  letter-spacing: 0.1em; text-transform: uppercase;
  color: var(--dim); background: none; border: none;
  border-bottom: 2px solid transparent; cursor: pointer;
  transition: all 0.2s; margin-bottom: -1px;
  white-space: nowrap; position: relative;
}
.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

/* Notification dot on tab */
.tab-notif {
  display: inline-block; background: var(--red); color: #fff;
  font-size: 8px; border-radius: 8px; padding: 1px 5px;
  margin-left: 5px; vertical-align: middle; min-width: 16px;
  text-align: center; line-height: 14px;
  opacity: 0; transition: opacity 0.3s;
}
.tab-notif.visible { opacity: 1; }

/* Tab panels */
.tab-panel { display: none; padding: 20px; flex-direction: column; gap: 16px; }
.tab-panel.active { display: flex; }

/* Cards */
.card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 2px; overflow: hidden;
}
.card-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; border-bottom: 1px solid var(--border);
  background: var(--panel);
}
.card-title {
  font-family: var(--head); font-size: 13px; font-weight: 600;
  letter-spacing: 0.12em; color: var(--bright);
}
.card-body { padding: 14px; }

/* Status grid */
.status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.stat-block {
  background: var(--panel); border: 1px solid var(--border);
  padding: 12px; border-radius: 2px;
}
.stat-val {
  font-family: var(--head); font-size: 26px; font-weight: 600;
  color: var(--bright); line-height: 1;
}
.stat-label { font-size: 9px; letter-spacing: 0.1em; color: var(--dim); margin-top: 4px; text-transform: uppercase; }

/* Operator vocab */
.vocab-cloud { display: flex; flex-wrap: wrap; gap: 6px; }
.vocab-word {
  font-size: 10px; padding: 2px 8px; border-radius: 2px;
  background: var(--border); color: var(--text);
  border: 1px solid var(--bh);
}

/* Worker panel */
.worker-spawn-form { display: flex; flex-direction: column; gap: 10px; }
.form-row { display: flex; gap: 8px; }
.goal-input {
  flex: 1; background: var(--panel); border: 1px solid var(--bh);
  border-radius: 2px; color: var(--bright); font-family: var(--mono);
  font-size: 12px; padding: 9px 12px; outline: none;
  transition: border-color 0.2s;
}
.goal-input:focus { border-color: var(--accent); }
.goal-input::placeholder { color: var(--dim); }

.auto-toggle {
  display: flex; align-items: center; gap: 8px;
  font-size: 10px; letter-spacing: 0.08em; color: var(--dim);
}
.toggle-switch {
  width: 32px; height: 16px; border-radius: 8px;
  border: 1px solid var(--bh); background: var(--border);
  cursor: pointer; position: relative; transition: all 0.2s;
}
.toggle-switch.on { background: var(--a2); border-color: var(--accent); }
.toggle-switch::after {
  content: ''; position: absolute; top: 2px; left: 2px;
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--dim); transition: all 0.2s;
}
.toggle-switch.on::after { left: 18px; background: var(--accent); box-shadow: 0 0 4px var(--accent); }

/* Buttons */
.btn {
  background: none; border: 1px solid var(--bh); border-radius: 2px;
  color: var(--text); font-family: var(--mono); font-size: 10px;
  letter-spacing: 0.1em; padding: 8px 16px; cursor: pointer;
  transition: all 0.2s; white-space: nowrap;
}
.btn:hover { border-color: var(--accent); color: var(--accent); }
.btn.primary {
  border-color: var(--accent); color: var(--accent);
  background: rgba(0,204,255,0.06);
}
.btn.primary:hover { background: rgba(0,204,255,0.14); }
.btn.success { border-color: var(--green); color: var(--green); }
.btn.success:hover { background: rgba(0,255,136,0.1); }
.btn.danger { border-color: var(--red); color: var(--red); }
.btn.danger:hover { background: rgba(255,51,85,0.1); }
.btn.amber { border-color: var(--amber); color: var(--amber); }
.btn.amber:hover { background: rgba(255,170,0,0.1); }
.btn:disabled { opacity: 0.3; cursor: default; }

/* Worker list */
.worker-list { display: flex; flex-direction: column; gap: 8px; }
.worker-row {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 12px; background: var(--panel); border: 1px solid var(--border);
  border-radius: 2px; transition: border-color 0.2s;
}
.worker-row:hover { border-color: var(--bh); }
.worker-id { font-size: 11px; color: var(--accent); min-width: 70px; letter-spacing: 0.04em; }
.worker-goal { flex: 1; font-size: 11px; color: var(--bright); line-height: 1.4; }
.worker-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
.status-badge {
  font-size: 9px; letter-spacing: 0.1em; padding: 2px 8px;
  border-radius: 2px; font-weight: 500; text-transform: uppercase;
}
.s-QUEUED    { background: rgba(0,204,255,0.1);  color: var(--accent); }
.s-RUNNING   { background: rgba(0,255,136,0.1);  color: var(--green); animation: pulse-glow 1.5s infinite; }
.s-COMPLETED { background: rgba(0,255,136,0.08); color: var(--green); }
.s-FAILED    { background: rgba(255,51,85,0.1);  color: var(--red); }
.s-CANCELLED { background: rgba(37,53,69,0.5);   color: var(--dim); }
.s-PAUSED    { background: rgba(255,170,0,0.1);  color: var(--amber); }
.s-PENDING   { background: rgba(0,204,255,0.08); color: var(--accent); }
.s-BLOCKED   { background: rgba(255,51,85,0.08); color: var(--red); }
@keyframes pulse-glow { 0%,100%{opacity:1} 50%{opacity:0.5} }

.worker-steps { display: flex; gap: 3px; margin-top: 4px; }
.step-pip {
  width: 20px; height: 3px; border-radius: 1px;
  background: var(--border); transition: background 0.3s;
}
.step-pip.done { background: var(--green); box-shadow: 0 0 4px var(--green); }
.step-pip.running { background: var(--amber); animation: pulse-glow 1s infinite; }
.step-pip.fail { background: var(--red); }

/* Companion */
.companion-window {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 2px; overflow: hidden;
  display: flex; flex-direction: column; height: 480px;
}
.companion-messages {
  flex: 1; overflow-y: auto; padding: 14px;
  display: flex; flex-direction: column; gap: 10px;
}
.msg { display: flex; flex-direction: column; gap: 3px; }
.msg-source {
  font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase;
}
.msg.op .msg-source { color: var(--accent); }
.msg.nx .msg-source { color: var(--purple); }
.msg-text {
  font-size: 12px; line-height: 1.6; padding: 8px 10px;
  border-radius: 2px; border-left: 2px solid;
  max-width: 90%;
}
.msg.op .msg-text { background: rgba(0,204,255,0.05); border-color: var(--accent); }
.msg.nx .msg-text { background: rgba(170,85,255,0.05); border-color: var(--purple); color: var(--bright); }
.companion-input-row {
  display: flex; border-top: 1px solid var(--border);
}
.companion-input {
  flex: 1; background: transparent; border: none; outline: none;
  color: var(--bright); font-family: var(--mono); font-size: 12px;
  padding: 12px 14px;
}
.companion-input::placeholder { color: var(--dim); }
.companion-send {
  background: none; border: none; border-left: 1px solid var(--border);
  color: var(--accent); font-family: var(--mono); font-size: 10px;
  letter-spacing: 0.1em; padding: 0 16px; cursor: pointer;
  transition: background 0.2s;
}
.companion-send:hover { background: rgba(0,204,255,0.06); }

/* Typing indicator */
.typing-indicator {
  display: none; align-items: center; gap: 4px;
  padding: 8px 10px;
}
.typing-indicator.visible { display: flex; }
.typing-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--purple); opacity: 0.4;
  animation: typing-bounce 1.2s infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing-bounce { 0%,60%,100%{transform:translateY(0);opacity:0.4} 30%{transform:translateY(-4px);opacity:1} }

/* Fusion block */
.fusion-block {
  background: var(--panel); border: 1px solid var(--border);
  padding: 12px; border-radius: 2px; font-size: 11px;
  line-height: 1.7; color: var(--text); white-space: pre-wrap;
  max-height: 200px; overflow-y: auto;
}

/* â”€â”€ MISSIONS TAB â”€â”€ */
.mission-list { display: flex; flex-direction: column; gap: 8px; }
.mission-row {
  padding: 12px; background: var(--panel); border: 1px solid var(--border);
  border-radius: 2px; transition: border-color 0.2s;
}
.mission-row:hover { border-color: var(--bh); }
.mission-top { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.rank-badge {
  font-size: 9px; font-weight: 700; letter-spacing: 0.1em;
  padding: 2px 7px; border-radius: 2px; border: 1px solid;
}
.rank-E, .rank-D { border-color: var(--accent); color: var(--accent); background: rgba(0,204,255,0.08); }
.rank-C, .rank-B { border-color: var(--amber); color: var(--amber); background: rgba(255,170,0,0.08); }
.rank-A, .rank-S { border-color: var(--red); color: var(--red); background: rgba(255,51,85,0.08); }
.mission-goal { flex: 1; font-size: 11px; color: var(--bright); }
.mission-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.mission-actions { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
.task-dag { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
.task-chip {
  font-size: 9px; padding: 2px 7px; border-radius: 2px;
  background: var(--border); color: var(--dim); border: 1px solid var(--bh);
}
.task-chip.done { color: var(--green); border-color: var(--green); background: rgba(0,255,136,0.06); }
.task-chip.fail { color: var(--red); border-color: var(--red); }
.task-chip.run { color: var(--amber); border-color: var(--amber); animation: pulse-glow 1s infinite; }
.mission-create-form { display: flex; flex-direction: column; gap: 10px; }
.form-select {
  background: var(--panel); border: 1px solid var(--bh); border-radius: 2px;
  color: var(--text); font-family: var(--mono); font-size: 10px;
  padding: 8px 10px; outline: none; cursor: pointer;
}

/* â”€â”€ VAULT TAB â”€â”€ */
.artifact-list { display: flex; flex-direction: column; gap: 8px; }
.artifact-row {
  padding: 12px; background: var(--panel); border: 1px solid var(--border);
  border-radius: 2px;
}
.artifact-top { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.type-badge {
  font-size: 9px; letter-spacing: 0.08em; padding: 2px 7px;
  border-radius: 2px; border: 1px solid var(--bh);
  color: var(--dim);
}
.artifact-title { flex: 1; font-size: 11px; color: var(--bright); }
.artifact-preview {
  font-size: 10px; color: var(--dim); line-height: 1.5;
  max-height: 40px; overflow: hidden;
  border-left: 2px solid var(--border); padding-left: 8px;
  margin-top: 4px;
}
.artifact-actions { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
.vault-filters { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

/* â”€â”€ COGNITION TAB â”€â”€ */
.cog-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.cog-block {
  background: var(--panel); border: 1px solid var(--border);
  padding: 12px; border-radius: 2px;
}
.cog-val {
  font-family: var(--head); font-size: 22px; font-weight: 600;
  color: var(--bright); line-height: 1;
}
.cog-label { font-size: 9px; letter-spacing: 0.1em; color: var(--dim); margin-top: 4px; text-transform: uppercase; }
.cog-sub { font-size: 10px; color: var(--accent); margin-top: 4px; }
.prediction-form { display: flex; flex-direction: column; gap: 8px; }
.pred-input {
  background: var(--panel); border: 1px solid var(--bh); border-radius: 2px;
  color: var(--bright); font-family: var(--mono); font-size: 11px;
  padding: 8px 10px; outline: none; width: 100%;
  transition: border-color 0.2s;
}
.pred-input:focus { border-color: var(--accent); }
.pred-input::placeholder { color: var(--dim); }
.pred-row { display: flex; gap: 8px; align-items: center; }
.pred-row label { font-size: 9px; color: var(--dim); letter-spacing: 0.08em; min-width: 80px; }

/* â”€â”€ WORKER DETAIL OVERLAY â”€â”€ */
.detail-overlay {
  position: fixed; inset: 0; background: rgba(3,5,10,0.92);
  z-index: 500; display: none; align-items: center; justify-content: center;
  padding: 24px;
}
.detail-overlay.open { display: flex; }
.detail-panel {
  background: var(--card); border: 1px solid var(--bh);
  border-radius: 2px; max-width: 680px; width: 100%;
  max-height: 80vh; overflow-y: auto;
  display: flex; flex-direction: column;
}
.detail-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  background: var(--panel); position: sticky; top: 0;
}
.detail-title { font-family: var(--head); font-size: 16px; font-weight: 600; letter-spacing: 0.1em; color: var(--bright); }
.detail-body { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.step-log-entry {
  padding: 8px 10px; background: var(--panel); border: 1px solid var(--border);
  border-radius: 2px; font-size: 10px; line-height: 1.5;
}
.step-log-entry.ok { border-left: 2px solid var(--green); }
.step-log-entry.fail { border-left: 2px solid var(--red); }
.step-num { color: var(--accent); margin-right: 8px; }
.step-type { color: var(--bright); }
.step-out { color: var(--dim); margin-top: 3px; word-break: break-all; }

/* â”€â”€ RIGHT SIDEBAR â€” event log â”€â”€ */
.sidebar-right {
  border-left: 1px solid var(--border);
  background: var(--panel);
  overflow-y: auto;
  display: flex; flex-direction: column;
}

.log-head {
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase;
  color: var(--dim); display: flex; align-items: center; justify-content: space-between;
}
.log-live { display: flex; align-items: center; gap: 5px; }
.live-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--green); box-shadow: 0 0 6px var(--green);
  animation: pulse-glow 2s infinite;
}

.event-list { flex: 1; overflow-y: auto; padding: 8px 0; }
.event-item {
  padding: 8px 16px; border-bottom: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 2px;
}
.event-type {
  font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase;
}
.et-STAGE_CHANGE    { color: var(--amber); }
.et-TRAIT_UNLOCKED  { color: var(--green); }
.et-WORKER          { color: var(--accent); }
.et-MISSION         { color: var(--purple); }
.et-COMPANION       { color: var(--dim); }
.et-ERROR           { color: var(--red); }
.et-VAULT           { color: var(--amber); }
.et-COGNITION       { color: var(--green); }
.event-msg { font-size: 11px; color: var(--text); line-height: 1.4; }
.event-ts { font-size: 9px; color: var(--dim); }

/* misc */
.empty { color: var(--dim); font-size: 11px; padding: 20px; text-align: center; }
.error-msg { color: var(--red); font-size: 11px; padding: 8px; border: 1px solid rgba(255,51,85,0.2); border-radius: 2px; }
.loading { color: var(--dim); font-size: 10px; letter-spacing: 0.08em; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.info-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border); }
.info-key { color: var(--dim); font-size: 10px; letter-spacing: 0.06em; }
.info-val { color: var(--bright); font-size: 10px; }
/* â”€â”€ Operator Rank Panel â”€â”€ */
.operator-card { display:flex; flex-direction:column; gap:18px; max-width:580px; }
.op-rank-section { display:flex; align-items:center; gap:16px; }
.op-rank-badge { width:62px; height:62px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:26px; font-weight:900; font-family:monospace; letter-spacing:2px; border:2px solid rgba(255,255,255,0.1); }
.rank-E { background:#1a1a1a; color:#666; }
.rank-D { background:#071830; color:#4a9eff; border-color:#1a3a6a; }
.rank-C { background:#071a0f; color:#4aff7a; border-color:#1a4a2a; }
.rank-B { background:#120730; color:#b44aff; border-color:#2a1a5a; }
.rank-A { background:#1a1007; color:#ffb44a; border-color:#4a2a1a; }
.rank-S { background:#1a0707; color:#ff4a4a; border-color:#4a1a1a; text-shadow:0 0 10px rgba(255,74,74,0.5); }
.op-rank-label { font-size:15px; font-weight:700; color:var(--bright); }
.op-tier-label { font-size:11px; color:var(--dim); margin-top:2px; }
.op-xp-section { background:rgba(255,255,255,0.025); border-radius:8px; padding:12px 14px; }
.op-xp-header { display:flex; justify-content:space-between; margin-bottom:8px; }
#op-xp-text { color:var(--bright); font-size:14px; font-weight:600; }
.op-xp-next { color:var(--dim); font-size:11px; }
.op-xp-track { width:100%; height:9px; background:#111; border-radius:5px; overflow:hidden; }
.op-xp-fill { height:100%; border-radius:5px; transition:width 0.6s ease, background 0.4s ease; }
.xp-E { background:linear-gradient(90deg,#333,#555); }
.xp-D { background:linear-gradient(90deg,#1a5aaa,#4a9eff); }
.xp-C { background:linear-gradient(90deg,#1a8a3a,#4aff7a); }
.xp-B { background:linear-gradient(90deg,#5a1aaa,#b44aff); }
.xp-A { background:linear-gradient(90deg,#aa6a1a,#ffb44a); }
.xp-S { background:linear-gradient(90deg,#aa1a1a,#ff4a4a); box-shadow:0 0 8px rgba(255,74,74,0.4); }
.op-xp-detail { font-size:11px; color:var(--dim); margin-top:6px; text-align:center; }
.op-section-title { font-size:10px; font-weight:700; color:var(--dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
.op-traits-grid, .op-perms-grid { display:flex; flex-wrap:wrap; gap:5px; }
.op-trait, .op-perm { padding:3px 9px; border-radius:4px; font-size:11px; font-weight:600; }
.op-trait.unlocked { background:rgba(74,255,122,0.08); color:#4aff7a; border:1px solid rgba(74,255,122,0.18); }
.op-trait.locked { background:rgba(255,255,255,0.02); color:#333; border:1px solid rgba(255,255,255,0.04); }
.op-perm.allowed { background:rgba(74,158,255,0.08); color:#4a9eff; border:1px solid rgba(74,158,255,0.15); }
.op-perm.denied { background:rgba(255,255,255,0.02); color:#333; border:1px solid rgba(255,255,255,0.04); }
.op-xp-history { display:flex; flex-direction:column; gap:4px; max-height:180px; overflow-y:auto; }
.op-xp-event { display:flex; justify-content:space-between; padding:4px 8px; font-size:11px; border-radius:3px; background:rgba(255,255,255,0.02); }
.op-xp-event .action { color:var(--text); }
.op-xp-event .points { color:#4aff7a; font-weight:700; }
.op-empty { color:var(--dim); font-size:11px; font-style:italic; }
</style>
</head>
<body>

<!-- TOPBAR -->
<header class="topbar">
  <div style="display:flex;align-items:center;gap:8px">
    <div class="logo">NEX<em>US</em>MON <span style="font-size:13px;color:var(--dim);font-weight:300">// GREENLINE ORGANISM</span></div>
  </div>
  <div class="topbar-right">
    <span class="last-updated" id="last-updated"></span>
    <span class="stage-badge" id="top-stage" style="color:var(--dim)">DORMANT</span>
    <span class="clock" id="clock"></span>
    <button class="refresh-btn" onclick="loadAll()">â†» SYNC</button>
  </div>
</header>

<div class="shell">

  <!-- LEFT SIDEBAR â€” Evolution -->
  <aside class="sidebar-left" id="sidebar-evo">
    <div class="side-section">
      <div class="side-label">Evolution Stage âš¡</div>
      <div class="evo-stage">
        <div class="evo-stage-name" id="stage-name">â€”</div>
        <div class="evo-rank-dots" id="rank-dots">
          <div class="rank-dot"></div>
          <div class="rank-dot"></div>
          <div class="rank-dot"></div>
          <div class="rank-dot"></div>
          <div class="rank-dot"></div>
        </div>
        <div class="xp-row">
          <span class="xp-label">XP</span>
          <span class="xp-val" id="xp-val">0</span>
          <div class="xp-bar"><div class="xp-fill" id="xp-fill" style="width:0%"></div></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
          <div style="text-align:center">
            <div style="font-size:18px;font-family:var(--head);font-weight:600;color:var(--bright)" id="total-missions">0</div>
            <div style="font-size:9px;color:var(--dim);letter-spacing:0.1em">MISSIONS</div>
          </div>
          <div style="width:1px;background:var(--border)"></div>
          <div style="text-align:center">
            <div style="font-size:18px;font-family:var(--head);font-weight:600;color:var(--green)" id="success-rate">0%</div>
            <div style="font-size:9px;color:var(--dim);letter-spacing:0.1em">SUCCESS</div>
          </div>
        </div>
      </div>
    </div>

    <div class="side-section" style="flex:1;overflow-y:auto">
      <div class="side-label">Active Traits <span id="trait-count" style="color:var(--accent)">0</span></div>
      <div class="trait-list" id="trait-list">
        <div class="loading">syncing glyphsâ€¦</div>
      </div>
    </div>

    <div class="side-section" id="next-stage-wrap" style="display:none">
      <div class="side-label">Next Stage Gate</div>
      <div class="next-stage-box">
        <div class="next-stage-name" id="next-stage-name">â€”</div>
        <div class="next-req">
          <span style="color:var(--dim)">missions</span>
          <span id="next-missions" style="color:var(--text)">â€”</span>
        </div>
        <div class="next-req">
          <span style="color:var(--dim)">success rate</span>
          <span id="next-rate" style="color:var(--text)">â€”</span>
        </div>
        <button class="btn" style="margin-top:10px;width:100%;font-size:9px" onclick="syncEvolution()">SYNC EVOLUTION</button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <nav class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('status')">STATUS ðŸŸ¢</button>
      <button class="tab-btn" onclick="switchTab('operator')">OPERATOR</button>
      <button class="tab-btn" onclick="switchTab('workers')">WORKERS</button>
      <button class="tab-btn" onclick="switchTab('companion')">COMPANION</button>
      <button class="tab-btn" onclick="switchTab('missions')">MISSIONS<span class="tab-notif" id="notif-missions"></span></button>
      <button class="tab-btn" onclick="switchTab('vault')">VAULT<span class="tab-notif" id="notif-vault"></span></button>
      <button class="tab-btn" onclick="switchTab('cognition')">COGNITION</button>
    </nav>

    <!-- STATUS TAB -->
    <div class="tab-panel active" id="tab-status">
      <div class="status-grid" id="status-grid">
        <div class="stat-block">
          <div class="stat-val" id="s-stage">â€”</div>
          <div class="stat-label">Stage</div>
        </div>
        <div class="stat-block">
          <div class="stat-val" id="s-workers">â€”</div>
          <div class="stat-label">Active Workers</div>
        </div>
        <div class="stat-block">
          <div class="stat-val" id="s-beliefs">â€”</div>
          <div class="stat-label">Beliefs Tracked</div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="card-title">OPERATOR CONTEXT</div>
          <button class="btn" onclick="loadFusion()" style="font-size:9px">VIEW FUSION GLYPH</button>
        </div>
        <div class="card-body">
          <div class="grid-2" id="operator-quick">
            <div class="info-row"><span class="info-key">Operator</span><span class="info-val" id="q-operator">â€”</span></div>
            <div class="info-row"><span class="info-key">Interactions</span><span class="info-val" id="q-interactions">â€”</span></div>
            <div class="info-row"><span class="info-key">Belief Revisions</span><span class="info-val" id="q-revisions">â€”</span></div>
            <div class="info-row"><span class="info-key">Autonomy Trust</span><span class="info-val" id="q-trust">â€”</span></div>
          </div>
          <div style="margin-top:12px">
            <div class="side-label" style="margin-bottom:8px">LINGO SIGNATURE</div>
            <div class="vocab-cloud" id="q-vocab"></div>
          </div>
          <div id="fusion-wrap" style="display:none;margin-top:12px">
            <div class="side-label" style="margin-bottom:6px">FUSION PROMPT GLYPH</div>
            <div class="fusion-block" id="fusion-content"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="card-title">ACTIVE WORKERS</div>
          <span id="workers-count-badge" style="font-size:10px;color:var(--dim)"></span>
        </div>
        <div class="card-body">
          <div id="active-workers-list"><div class="empty">No active workers in the swarm yet</div></div>
        </div>
      </div>
    </div>

    <!-- OPERATOR TAB -->
    <div class="tab-panel" id="tab-operator">
      <div class="operator-card">
        <div class="op-rank-section">
          <div id="op-rank-badge" class="op-rank-badge rank-E">E</div>
          <div class="op-rank-meta">
            <div id="op-rank-label" class="op-rank-label">Rank E â€” New Operator</div>
            <div id="op-tier-label" class="op-tier-label">Evolution: DORMANT</div>
          </div>
        </div>
        <div class="op-xp-section">
          <div class="op-xp-header">
            <span id="op-xp-text">0 XP</span>
            <span id="op-xp-next" class="op-xp-next">Next rank: 50 XP</span>
          </div>
          <div class="op-xp-track">
            <div id="op-xp-fill" class="op-xp-fill xp-E" style="width:0%"></div>
          </div>
          <div id="op-xp-detail" class="op-xp-detail">0 / 50 XP to Rank D</div>
        </div>
        <div class="op-traits-section">
          <div class="op-section-title">Traits</div>
          <div id="op-traits-grid" class="op-traits-grid"></div>
        </div>
        <div class="op-perms-section">
          <div class="op-section-title">Permissions</div>
          <div id="op-perms-grid" class="op-perms-grid"></div>
        </div>
        <div class="op-history-section">
          <div class="op-section-title">Recent XP</div>
          <div id="op-xp-history" class="op-xp-history">
            <div class="op-empty">No XP events yet. Complete missions to earn XP.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- WORKERS TAB -->
    <div class="tab-panel" id="tab-workers">
      <div class="card">
        <div class="card-head"><div class="card-title">SPAWN WORKER</div></div>
        <div class="card-body">
          <div class="worker-spawn-form">
            <div class="form-row">
              <input class="goal-input" id="worker-goal" placeholder="Goal â€” what should the worker do?"
                     onkeydown="if(event.key==='Enter')spawnWorker()" />
              <button class="btn primary" id="spawn-btn" onclick="spawnWorker()">SPAWN</button>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div class="auto-toggle">
                <div class="toggle-switch on" id="auto-toggle" onclick="toggleAuto()"></div>
                <span id="auto-label">AUTONOMOUS CHAIN</span>
              </div>
              <span style="font-size:9px;color:var(--dim)" id="auto-gate"></span>
            </div>
            <div id="spawn-error" style="display:none" class="error-msg"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-head">
          <div class="card-title">WORKER LOG</div>
          <div style="display:flex;gap:8px">
            <select id="worker-filter" onchange="loadWorkers()" class="form-select">
              <option value="">ALL</option>
              <option value="RUNNING">RUNNING</option>
              <option value="COMPLETED">COMPLETED</option>
              <option value="FAILED">FAILED</option>
              <option value="QUEUED">QUEUED</option>
            </select>
            <button class="btn" onclick="loadWorkers()">â†»</button>
          </div>
        </div>
        <div class="card-body">
          <div class="worker-list" id="worker-list"><div class="loading">syncing worker feedâ€¦</div></div>
        </div>
      </div>
    </div>

    <!-- COMPANION TAB -->
    <div class="tab-panel" id="tab-companion">
      <div class="companion-window">
        <div class="companion-messages" id="companion-msgs">
          <div class="msg nx">
            <div class="msg-source">NEXUSMON</div>
            <div class="msg-text">Organism online. Operator context loaded. Ready.</div>
          </div>
        </div>
        <div class="typing-indicator" id="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <div class="companion-input-row">
          <input class="companion-input" id="companion-input" placeholder="Transmit to NEXUSMONâ€¦"
                 onkeydown="if(event.key==='Enter')sendCompanion()" />
          <button class="companion-send" onclick="sendCompanion()">SEND â–¶</button>
        </div>
      </div>
    </div>

    <!-- MISSIONS TAB -->
    <div class="tab-panel" id="tab-missions">
      <div class="card">
        <div class="card-head"><div class="card-title">CREATE MISSION</div></div>
        <div class="card-body">
          <div class="mission-create-form">
            <div class="form-row">
              <input class="goal-input" id="mission-goal" placeholder="Mission objectiveâ€¦"
                     onkeydown="if(event.key==='Enter')createMission()" />
              <select id="mission-rank" class="form-select" style="width:80px">
                <option value="E">E</option>
                <option value="D" selected>D</option>
                <option value="C">C</option>
                <option value="B">B</option>
                <option value="A">A</option>
                <option value="S">S</option>
              </select>
              <button class="btn primary" id="create-mission-btn" onclick="createMission()">CREATE</button>
            </div>
            <div id="mission-create-error" style="display:none" class="error-msg"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-head">
          <div class="card-title">MISSION LOG</div>
          <div style="display:flex;gap:8px;align-items:center">
            <span id="missions-stats-badge" style="font-size:10px;color:var(--dim)"></span>
            <button class="btn" onclick="loadMissions()">â†»</button>
          </div>
        </div>
        <div class="card-body">
          <div class="mission-list" id="mission-list"><div class="loading">syncing mission logâ€¦</div></div>
        </div>
      </div>
    </div>

    <!-- VAULT TAB -->
    <div class="tab-panel" id="tab-vault">
      <div class="card">
        <div class="card-head">
          <div class="card-title">ARTIFACT VAULT</div>
          <div class="vault-filters">
            <select id="vault-status-filter" onchange="loadVault()" class="form-select">
              <option value="">ALL STATUS</option>
              <option value="PENDING_REVIEW">PENDING REVIEW</option>
              <option value="APPROVED">APPROVED</option>
              <option value="REJECTED">REJECTED</option>
            </select>
            <select id="vault-type-filter" onchange="loadVault()" class="form-select">
              <option value="">ALL TYPES</option>
              <option value="LOG">LOG</option>
              <option value="TEXT">TEXT</option>
              <option value="CODE">CODE</option>
              <option value="DATA">DATA</option>
              <option value="REPORT">REPORT</option>
              <option value="ANALYSIS">ANALYSIS</option>
              <option value="DECISION">DECISION</option>
            </select>
            <button class="btn" onclick="loadVault()">â†»</button>
          </div>
        </div>
        <div class="card-body">
          <div id="vault-stats" style="margin-bottom:10px;font-size:10px;color:var(--dim)"></div>
          <div class="artifact-list" id="artifact-list"><div class="loading">syncing vault streamâ€¦</div></div>
        </div>
      </div>
    </div>

    <!-- COGNITION TAB -->
    <div class="tab-panel" id="tab-cognition">
      <div class="cog-grid" id="cog-grid">
        <div class="cog-block">
          <div class="cog-val" id="cog-predictions">â€”</div>
          <div class="cog-label">Predictions</div>
          <div class="cog-sub" id="cog-brier">Brier â€”</div>
        </div>
        <div class="cog-block">
          <div class="cog-val" id="cog-errors">â€”</div>
          <div class="cog-label">Errors Logged</div>
          <div class="cog-sub" id="cog-dominant-error">Dominant â€”</div>
        </div>
        <div class="cog-block">
          <div class="cog-val" id="cog-autopsies">â€”</div>
          <div class="cog-label">Autopsies</div>
          <div class="cog-sub" id="cog-decisions">Decisions â€”</div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><div class="card-title">LOG PREDICTION</div></div>
        <div class="card-body">
          <div class="prediction-form">
            <input class="pred-input" id="pred-claim" placeholder="Claim being predictedâ€¦" />
            <div class="pred-row">
              <label>Confidence</label>
              <input class="pred-input" id="pred-confidence" type="number" min="0" max="1" step="0.05"
                     placeholder="0.0 â€“ 1.0" style="width:120px" />
              <label style="margin-left:12px">Category</label>
              <input class="pred-input" id="pred-category" placeholder="e.g. TECHNICAL" style="width:140px" />
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn primary" onclick="logPrediction()">LOG PREDICTION</button>
              <span id="pred-result" style="font-size:10px;color:var(--dim);align-self:center"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><div class="card-title">DECISION AUTOPSY</div></div>
        <div class="card-body">
          <div class="prediction-form">
            <input class="pred-input" id="autopsy-decision" placeholder="Decision or action takenâ€¦" />
            <input class="pred-input" id="autopsy-outcome" placeholder="What actually happenedâ€¦" />
            <div class="pred-row">
              <label>Quality (0â€“1)</label>
              <input class="pred-input" id="autopsy-quality" type="number" min="0" max="1" step="0.1"
                     placeholder="0.0 â€“ 1.0" style="width:120px" />
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn primary" onclick="submitAutopsy()">SUBMIT AUTOPSY</button>
              <span id="autopsy-result" style="font-size:10px;color:var(--dim);align-self:center"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- RIGHT SIDEBAR â€” Event Log -->
  <aside class="sidebar-right">
    <div class="log-head">
      <span>EVENT LOG // LIVE FEED</span>
      <div class="log-live"><div class="live-dot"></div><span>LIVE</span></div>
    </div>
    <div class="event-list" id="event-list">
      <div class="empty">awaiting signal eventsâ€¦</div>
    </div>
  </aside>

</div>

<!-- WORKER DETAIL OVERLAY -->
<div class="detail-overlay" id="detail-overlay" onclick="if(event.target===this)closeDetail()">
  <div class="detail-panel">
    <div class="detail-head">
      <div class="detail-title" id="detail-title">WORKER DETAIL</div>
      <button class="btn danger" style="font-size:9px" onclick="closeDetail()">CLOSE âœ•</button>
    </div>
    <div class="detail-body" id="detail-body"></div>
  </div>
</div>

<script>
const API = '';
let autoOn = true;
let eventLog = [];
let lastSyncData = { total: 0, success: 0, beliefs: 0 };

// â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tickClock() {
  const d = new Date();
  document.getElementById('clock').textContent =
    d.toUTCString().replace('GMT','UTC').split(' ').slice(1).join(' ');
}
setInterval(tickClock, 1000); tickClock();

function setLastUpdated() {
  const el = document.getElementById('last-updated');
  if (el) el.textContent = 'signal synced ' + new Date().toLocaleTimeString();
}

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const btn = document.querySelector(`.tab-btn[onclick*="'${name}'"]`);
  if (btn) btn.classList.add('active');
  const panel = document.getElementById('tab-' + name);
  if (panel) panel.classList.add('active');
  if (name === 'operator') loadOperator();
  if (name === 'workers') loadWorkers();
  if (name === 'missions') loadMissions();
  if (name === 'vault') loadVault();
  if (name === 'cognition') loadCognition();
}

// â”€â”€ Stage colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STAGE_COLORS = {
  DORMANT: '#2a4050', AWAKENING: '#0088cc', FORGING: '#cc7700',
  SOVEREIGN: '#00aa55', APEX: '#8844cc'
};
const STAGE_RANK = { DORMANT:0, AWAKENING:1, FORGING:2, SOVEREIGN:3, APEX:4 };

function applyStage(stage) {
  const color = STAGE_COLORS[stage] || STAGE_COLORS.DORMANT;
  const rank = STAGE_RANK[stage] || 0;
  document.getElementById('stage-name').textContent = stage;
  document.getElementById('stage-name').style.color = color;
  document.getElementById('top-stage').textContent = stage;
  document.getElementById('top-stage').style.color = color;
  document.getElementById('s-stage').textContent = stage;
  document.getElementById('s-stage').style.color = color;
  const dots = document.querySelectorAll('.rank-dot');
  dots.forEach((d, i) => {
    d.classList.toggle('filled', i <= rank);
    if (i <= rank) { d.style.background = color; d.style.borderColor = color; d.style.boxShadow = `0 0 6px ${color}`; }
    else { d.style.background = ''; d.style.boxShadow = ''; d.style.borderColor = ''; }
  });
  // Stage color on sidebar border
  const sidebar = document.getElementById('sidebar-evo');
  if (sidebar) sidebar.style.borderLeftColor = color;
}

// â”€â”€ Load all (organism/status) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAll() {
  try {
    const r = await fetch(API + '/v1/nexusmon/organism/status');
    const data = await r.json();
    if (!data.ok) throw new Error(JSON.stringify(data));

    // Evolution
    const evo = data.evolution || {};
    applyStage(evo.stage || 'DORMANT');
    document.getElementById('xp-val').textContent = evo.xp || 0;
    document.getElementById('xp-fill').style.width = Math.min(100, (evo.xp || 0) / 50) + '%';
    document.getElementById('total-missions').textContent = evo.total_missions || 0;
    document.getElementById('success-rate').textContent = Math.round((evo.success_rate || 0) * 100) + '%';
    document.getElementById('trait-count').textContent = (evo.active_traits || []).length;

    // Track real values for syncEvolution
    const beliefs = data.claimlab?.belief_count || 0;
    const total = evo.total_missions || 0;
    const success = Math.round((evo.success_rate || 0) * total);
    lastSyncData = { total, success, beliefs };

    // Traits
    const tl = document.getElementById('trait-list');
    const traits = evo.active_traits || [];
    tl.innerHTML = traits.length ? traits.map(t => `
      <div class="trait-item">
        <div class="trait-dot cat-${t.category}"></div>
        <span class="trait-name">${t.label || t.id}</span>
        <span class="trait-cat">${(t.category||'').slice(0,3)}</span>
      </div>`).join('') : '<div class="empty">No traits unlocked yet â€” run missions to awaken</div>';

    // Next stage
    if (evo.next_stage) {
      document.getElementById('next-stage-wrap').style.display = 'block';
      document.getElementById('next-stage-name').textContent = evo.next_stage.label || evo.next_stage.name;
      document.getElementById('next-missions').textContent = evo.next_stage.requires_missions || evo.next_stage.min_missions;
      document.getElementById('next-rate').textContent = Math.round((evo.next_stage.requires_success_rate || evo.next_stage.min_rate || 0) * 100) + '%';
    }

    // Recent events â†’ sidebar
    const recentEvts = evo.recent_events || [];
    recentEvts.forEach(e => pushEvent(e.type || 'EVENT', e.to || e.label || e.trait || '', e.timestamp));

    // Operator quick
    const op = data.operator || {};
    document.getElementById('q-operator').textContent = op.operator_id || 'â€”';
    document.getElementById('q-interactions').textContent = op.total_interactions || 0;
    document.getElementById('q-revisions').textContent = op.belief_calibration?.revisions || op.belief_calibration?.total_revisions || 0;
    const trust = op.trust_signals || op.trust || {};
    const pref = trust.autonomy_preference ?? trust.preference;
    document.getElementById('q-trust').textContent = pref != null ? Math.round(pref * 100) + '%' : 'â€”';

    // Vocab
    const vocab = document.getElementById('q-vocab');
    vocab.innerHTML = (op.vocab_signature || []).map(w =>
      `<span class="vocab-word">${w}</span>`).join('');

    // Workers
    const wdata = data.workers || {};
    document.getElementById('s-workers').textContent = wdata.active_count || 0;
    document.getElementById('workers-count-badge').textContent = (wdata.total || 0) + ' total';
    const awl = document.getElementById('active-workers-list');
    const active = wdata.active || [];
    awl.innerHTML = active.length ? active.map(renderWorkerRow).join('') :
      '<div class="empty">No active workers in the swarm</div>';

    // ClaimLab
    const cl = data.claimlab || {};
    document.getElementById('s-beliefs').textContent = cl.belief_count || 0;

    // Check autonomous chain trait
    const hasChain = traits.some(t => t.id === 'AUTONOMOUS_CHAIN');
    document.getElementById('auto-gate').textContent = hasChain ? '' : 'AUTONOMOUS_CHAIN locked â€” forge more XP';

    setLastUpdated();
    updateNotifDots();
  } catch (e) {
    pushEvent('ERROR', e.message, new Date().toISOString());
  }
}

// â”€â”€ Evolution sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function syncEvolution() {
  const btn = document.querySelector('[onclick="syncEvolution()"]');
  if (btn) { btn.disabled = true; btn.textContent = 'SYNCINGâ€¦'; }
  try {
    const r = await fetch(API + '/v1/nexusmon/organism/evolution/sync', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        total_missions: lastSyncData.total,
        success_count: lastSyncData.success,
        belief_count: lastSyncData.beliefs
      })
    });
    const data = await r.json();
    if (data.ok) {
      (data.events || []).forEach(e => pushEvent(e.type, e.to || e.label || '', e.timestamp));
      await loadAll();
    } else {
      pushEvent('ERROR', 'Sync failed: ' + JSON.stringify(data), new Date().toISOString());
    }
  } catch(e) {
    pushEvent('ERROR', 'Sync error: ' + e.message, new Date().toISOString());
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'SYNC EVOLUTION'; }
  }
}

// â”€â”€ Operator full â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _RANK_LABELS = {E:'New Operator',D:'Initiate',C:'Controller',B:'Overseer',A:'Commander',S:'Sovereign Operator'};
const _RANK_TO_TIER = {E:'DORMANT',D:'INITIATED',C:'ACTIVE',B:'EVOLVED',A:'ASCENDED',S:'ASCENDED'};
const _ALL_TRAITS = ['Worker Control','Artifact Review','Evolution Sync','Mission Governance',
  'Module Activation','Multi-Worker Coordination','Full Governance','System-Level Reasoning',
  'Organism Override','Evolution Tier Unlock'];
const _PERM_LABELS = {
  run_mission_E:'Run E Missions', run_mission_D:'Run D Missions', run_mission_C:'Run C Missions',
  run_mission_B:'Run B Missions', run_mission_A:'Run A Missions', run_mission_S:'Run S Missions',
  approve_artifact:'Approve Artifacts', reject_artifact:'Reject Artifacts',
  approve_mission:'Approve Missions', spawn_worker:'Spawn Workers',
  activate_module:'Activate Modules', evolution_sync:'Evolution Sync',
  full_organism_control:'Organism Control'
};

async function loadOperator() {
  try {
    const [rankRes, histRes] = await Promise.all([
      fetch(API + '/v1/operator/rank'),
      fetch(API + '/v1/operator/xp/history')
    ]);
    const rankData = await rankRes.json();
    const histData = await histRes.json();
    _renderOperatorPanel(rankData, histData);
  } catch(e) {
    pushEvent('ERROR', 'Operator load failed: ' + e.message, new Date().toISOString());
  }
}

function _renderOperatorPanel(data, histData) {
  const rank = data.rank || 'E';
  const xp = data.xp || 0;
  const nextRank = data.next_rank;
  const xpNeeded = data.xp_needed || 0;
  const progress = data.progress || 0;
  const traits = data.traits || [];
  const perms = data.permissions || {};
  const tier = _RANK_TO_TIER[rank] || 'DORMANT';

  const badge = document.getElementById('op-rank-badge');
  badge.textContent = rank;
  badge.className = 'op-rank-badge rank-' + rank;

  document.getElementById('op-rank-label').textContent = 'Rank ' + rank + ' â€” ' + (_RANK_LABELS[rank] || '');
  document.getElementById('op-tier-label').textContent = 'Evolution: ' + tier;
  document.getElementById('op-xp-text').textContent = xp + ' XP';

  const nextEl = document.getElementById('op-xp-next');
  nextEl.textContent = nextRank ? 'Next: Rank ' + nextRank + ' (' + xpNeeded + ' XP)' : 'MAX RANK';

  const fill = document.getElementById('op-xp-fill');
  fill.style.width = (progress * 100) + '%';
  fill.className = 'op-xp-fill xp-' + rank;

  const detailEl = document.getElementById('op-xp-detail');
  if (nextRank) {
    detailEl.textContent = xp + ' / ' + (xp + xpNeeded) + ' XP to Rank ' + nextRank;
  } else {
    detailEl.textContent = 'Sovereign Operator â€” Maximum Rank Achieved';
  }

  document.getElementById('op-traits-grid').innerHTML = _ALL_TRAITS.map(t => {
    const unlocked = traits.includes(t);
    return `<span class="op-trait ${unlocked?'unlocked':'locked'}">${unlocked?'âœ“ ':'âœ— '}${t}</span>`;
  }).join('');

  document.getElementById('op-perms-grid').innerHTML = Object.entries(_PERM_LABELS).map(([key, label]) => {
    const allowed = perms[key] === true;
    return `<span class="op-perm ${allowed?'allowed':'denied'}">${allowed?'âœ“':'âœ—'} ${label}</span>`;
  }).join('');

  const history = (histData.history || []).slice(-10).reverse();
  const histEl = document.getElementById('op-xp-history');
  histEl.innerHTML = history.length ? history.map(e => {
    const action = (e.action || '').replace(/_/g, ' ');
    return `<div class="op-xp-event"><span class="action">${action}${e.detail?' â€” '+e.detail:''}</span><span class="points">+${e.xp} XP</span></div>`;
  }).join('') : '<div class="op-empty">No XP events yet. Complete missions to earn XP.</div>';
}

// â”€â”€ Fusion block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFusion(full = false) {
  try {
    const r = await fetch(API + '/v1/nexusmon/organism/operator/fusion');
    const data = await r.json();
    const block = data.fusion_block || '(no fusion block)';
    if (full) {
      document.getElementById('fusion-full').textContent = block;
    } else {
      const fw = document.getElementById('fusion-wrap');
      const fc = document.getElementById('fusion-content');
      fw.style.display = fw.style.display === 'none' ? 'block' : 'none';
      fc.textContent = block;
    }
  } catch(e) {
    if (full) {
      document.getElementById('fusion-full').textContent = 'Error: ' + e.message;
    }
  }
}

// â”€â”€ Workers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAuto() {
  autoOn = !autoOn;
  const el = document.getElementById('auto-toggle');
  el.classList.toggle('on', autoOn);
  document.getElementById('auto-label').style.color = autoOn ? 'var(--text)' : 'var(--dim)';
}

async function spawnWorker() {
  const goal = document.getElementById('worker-goal').value.trim();
  if (!goal) return;
  const btn = document.getElementById('spawn-btn');
  const errEl = document.getElementById('spawn-error');
  errEl.style.display = 'none';
  btn.disabled = true; btn.textContent = 'SPAWNING UNITâ€¦';
  try {
    const r = await fetch(API + '/v1/nexusmon/organism/worker/spawn', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({goal, autonomous: autoOn})
    });
    const data = await r.json();
    if (data.ok) {
      pushEvent('WORKER', `Spawned ${data.worker_id} â€” ${goal.slice(0,40)}`, new Date().toISOString());
      document.getElementById('worker-goal').value = '';
      switchTab('workers');
      setTimeout(loadWorkers, 600);
    } else {
      errEl.textContent = 'Spawn gate failed: ' + (data.detail || JSON.stringify(data));
      errEl.style.display = 'block';
    }
  } catch(e) {
    errEl.textContent = 'Spawn error: ' + e.message;
    errEl.style.display = 'block';
  }
  btn.disabled = false; btn.textContent = 'SPAWN';
}

async function loadWorkers() {
  const status = document.getElementById('worker-filter').value;
  const url = API + '/v1/nexusmon/organism/worker' + (status ? `?status=${status}` : '');
  const el = document.getElementById('worker-list');
  try {
    const r = await fetch(url);
    const data = await r.json();
    const workers = data.workers || [];
    el.innerHTML = workers.length ? workers.map(renderWorkerRow).join('') :
      '<div class="empty">No workers found</div>';
  } catch(e) {
    el.innerHTML = `<div class="error-msg">Worker feed failed to load: ${e.message}</div>`;
  }
}

function renderWorkerRow(w) {
  const steps = w.steps || [];
  const log = w.step_log || [];
  const pips = steps.map((s, i) => {
    const logEntry = log.find(l => l.step === i);
    const cls = logEntry ? (logEntry.status === 'COMPLETED' ? 'done' : logEntry.status === 'FAILED' ? 'fail' : 'running') :
                (s.status === 'RUNNING' ? 'running' : '');
    return `<div class="step-pip ${cls}"></div>`;
  }).join('');

  const canCancel = ['QUEUED','PAUSED'].includes(w.status);
  return `
    <div class="worker-row">
      <div>
        <div class="worker-id">#${w.id}</div>
        <div style="font-size:9px;color:var(--dim);margin-top:3px">${w.autonomous ? 'AUTO' : 'MANUAL'}</div>
      </div>
      <div style="flex:1">
        <div class="worker-goal">${w.goal}</div>
        <div class="worker-steps" style="margin-top:6px">${pips}</div>
        ${w.error ? `<div style="font-size:10px;color:var(--red);margin-top:4px">${w.error}</div>` : ''}
        ${w.output && w.status==='COMPLETED' ? `<div style="font-size:10px;color:var(--green);margin-top:4px">âœ“ ${JSON.stringify(w.output).slice(0,80)}</div>` : ''}
      </div>
      <div class="worker-meta">
        <span class="status-badge s-${w.status}">${w.status}</span>
        <span style="font-size:9px;color:var(--dim)">${fmtDate(w.created_at)}</span>
        ${canCancel ? `<button class="btn danger" style="font-size:9px;padding:3px 8px" onclick="cancelWorker('${w.id}')">CANCEL</button>` : ''}
        <button class="btn" style="font-size:9px;padding:3px 8px" onclick="loadWorkerDetail('${w.id}')">DETAIL</button>
      </div>
    </div>`;
}

async function cancelWorker(id) {
  try {
    const r = await fetch(API + '/v1/nexusmon/organism/worker/' + id, {method:'DELETE'});
    const data = await r.json();
    if (data.ok !== false) {
      pushEvent('WORKER', `Cancelled ${id}`, new Date().toISOString());
      loadWorkers();
    } else {
      pushEvent('ERROR', `Cancel failed: ${data.detail || JSON.stringify(data)}`, new Date().toISOString());
    }
  } catch(e) {
    pushEvent('ERROR', `Cancel error: ${e.message}`, new Date().toISOString());
  }
}

async function loadWorkerDetail(id) {
  try {
    const r = await fetch(API + '/v1/nexusmon/organism/worker/' + id);
    const data = await r.json();
    const w = data.worker || data;
    showWorkerDetail(w);
  } catch(e) {
    pushEvent('ERROR', `Detail fetch error: ${e.message}`, new Date().toISOString());
  }
}

function showWorkerDetail(w) {
  document.getElementById('detail-title').textContent = `WORKER #${w.id}`;
  const logEntries = (w.step_log || []).map(s => `
    <div class="step-log-entry ${s.status==='COMPLETED'?'ok':s.status==='FAILED'?'fail':''}">
      <span class="step-num">[${s.step}]</span>
      <span class="step-type">${s.type}</span>
      <span class="status-badge s-${s.status}" style="margin-left:8px;font-size:8px">${s.status}</span>
      <div class="step-out">${s.output ? JSON.stringify(s.output).slice(0,200) : s.error || ''}</div>
    </div>`).join('') || '<div class="empty">No step log</div>';

  document.getElementById('detail-body').innerHTML = `
    <div class="info-row"><span class="info-key">Status</span><span class="info-val"><span class="status-badge s-${w.status}">${w.status}</span></span></div>
    <div class="info-row"><span class="info-key">Goal</span><span class="info-val" style="max-width:360px;word-break:break-word">${w.goal}</span></div>
    <div class="info-row"><span class="info-key">Mode</span><span class="info-val">${w.autonomous ? 'AUTONOMOUS' : 'MANUAL'}</span></div>
    <div class="info-row"><span class="info-key">Created</span><span class="info-val">${fmtDate(w.created_at)}</span></div>
    <div class="info-row"><span class="info-key">Completed</span><span class="info-val">${fmtDate(w.completed_at)}</span></div>
    ${w.error ? `<div class="error-msg">${w.error}</div>` : ''}
    <div class="side-label" style="margin:12px 0 6px">STEP LOG</div>
    ${logEntries}
    ${w.output ? `<div class="side-label" style="margin:12px 0 6px">OUTPUT</div>
    <pre style="font-size:10px;color:var(--bright);background:var(--panel);padding:10px;border:1px solid var(--border);border-radius:2px;overflow-x:auto;white-space:pre-wrap">${JSON.stringify(w.output, null, 2).slice(0,1000)}</pre>` : ''}
  `;
  document.getElementById('detail-overlay').classList.add('open');
}

function closeDetail() {
  document.getElementById('detail-overlay').classList.remove('open');
}

// â”€â”€ Companion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendCompanion() {
  const input = document.getElementById('companion-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  addMsg('op', text);
  const typing = document.getElementById('typing-indicator');
  typing.classList.add('visible');
  try {
    const r = await fetch(API + '/v1/nexusmon/organism/companion', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({text})
    });
    const data = await r.json();
    typing.classList.remove('visible');
    addMsg('nx', data.ok ? data.reply : `ERROR: ${data.error || data.detail}`);
    pushEvent('COMPANION', text.slice(0,40), new Date().toISOString());
  } catch(e) {
    typing.classList.remove('visible');
    addMsg('nx', `[offline] ${e.message}`);
  }
}

function addMsg(src, text) {
  const msgs = document.getElementById('companion-msgs');
  const div = document.createElement('div');
  div.className = 'msg ' + src;
  div.innerHTML = `
    <div class="msg-source">${src === 'op' ? 'OPERATOR' : 'NEXUSMON'}</div>
    <div class="msg-text">${text}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

// â”€â”€ Missions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createMission() {
  const goal = document.getElementById('mission-goal').value.trim();
  const rank = document.getElementById('mission-rank').value;
  if (!goal) return;
  const btn = document.getElementById('create-mission-btn');
  const errEl = document.getElementById('mission-create-error');
  errEl.style.display = 'none';
  btn.disabled = true; btn.textContent = 'FORGING MISSIONâ€¦';
  try {
    const r = await fetch(API + '/v1/engine/missions', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({goal, rank})
    });
    const data = await r.json();
    if (data.ok) {
      document.getElementById('mission-goal').value = '';
      pushEvent('MISSION', `Created ${data.mission?.id} [${rank}] â€” ${goal.slice(0,40)}`, new Date().toISOString());
      loadMissions();
    } else {
      errEl.textContent = 'Mission forge failed: ' + (data.detail || JSON.stringify(data));
      errEl.style.display = 'block';
    }
  } catch(e) {
    errEl.textContent = 'Create error: ' + e.message;
    errEl.style.display = 'block';
  }
  btn.disabled = false; btn.textContent = 'CREATE';
}

async function loadMissions() {
  const el = document.getElementById('mission-list');
  const statsEl = document.getElementById('missions-stats-badge');
  el.innerHTML = '<div class="loading">syncing mission logâ€¦</div>';
  try {
    const [listR, statsR] = await Promise.all([
      fetch(API + '/v1/engine/missions?limit=30'),
      fetch(API + '/v1/engine/missions/stats')
    ]);
    const listData = await listR.json();
    const statsData = await statsR.json();

    const missions = listData.missions || [];
    if (statsData.ok) {
      statsEl.textContent = `${statsData.total || 0} total`;
      // Update notif dot for blocked missions
      const blocked = (statsData.by_status || {}).BLOCKED || 0;
      updateNotifDot('notif-missions', blocked);
    }

    el.innerHTML = missions.length ? missions.map(renderMissionRow).join('') :
      '<div class="empty">No missions yet â€” drop your first objective</div>';
  } catch(e) {
    el.innerHTML = `<div class="error-msg">Mission log failed to load: ${e.message}</div>`;
  }
}

function renderMissionRow(m) {
  const tasks = m.tasks || [];
  const chips = tasks.map(t => {
    const cls = t.status === 'COMPLETED' ? 'done' : t.status === 'FAILED' ? 'fail' : t.status === 'RUNNING' ? 'run' : '';
    return `<span class="task-chip ${cls}">${(t.type || t.description || '').slice(0,20)}</span>`;
  }).join('');

  const isBlocked = m.status === 'BLOCKED';
  const isPending = m.status === 'PENDING';
  const isHighRisk = ['A','S'].includes(m.rank);

  return `
    <div class="mission-row">
      <div class="mission-top">
        <span class="rank-badge rank-${m.rank}">${m.rank}</span>
        <span class="mission-goal">${m.goal}</span>
        <span class="status-badge s-${m.status}" style="flex-shrink:0">${m.status}</span>
      </div>
      <div class="mission-meta">
        <span style="font-size:9px;color:var(--dim)">${fmtDate(m.created_at)}</span>
        ${m.xp_awarded ? `<span style="font-size:9px;color:var(--green)">+${m.xp_awarded} XP</span>` : ''}
        <span style="font-size:9px;color:var(--dim)">${tasks.length} task${tasks.length!==1?'s':''}</span>
      </div>
      ${chips ? `<div class="task-dag">${chips}</div>` : ''}
      <div class="mission-actions">
        ${isBlocked && isHighRisk ? `<button class="btn amber" style="font-size:9px;padding:4px 10px" onclick="approveMission('${m.id}')">APPROVE [${m.rank}-RANK]</button>` : ''}
        ${isPending ? `<button class="btn success" style="font-size:9px;padding:4px 10px" onclick="runMission('${m.id}')">RUN</button>` : ''}
        ${['PENDING','BLOCKED'].includes(m.status) ? `<button class="btn danger" style="font-size:9px;padding:4px 10px" onclick="cancelMission('${m.id}')">CANCEL</button>` : ''}
      </div>
    </div>`;
}

async function approveMission(id) {
  try {
    const r = await fetch(API + `/v1/engine/missions/${id}/approve`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: '{}'
    });
    const data = await r.json();
    if (data.ok) {
      pushEvent('MISSION', `Approved mission ${id}`, new Date().toISOString());
      loadMissions();
    } else {
      pushEvent('ERROR', `Approve failed: ${data.detail || JSON.stringify(data)}`, new Date().toISOString());
    }
  } catch(e) {
    pushEvent('ERROR', `Approve error: ${e.message}`, new Date().toISOString());
  }
}

async function runMission(id) {
  try {
    const r = await fetch(API + `/v1/engine/missions/${id}/run`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: '{}'
    });
    const data = await r.json();
    if (data.ok) {
      pushEvent('MISSION', `Running mission ${id}`, new Date().toISOString());
      setTimeout(loadMissions, 800);
    } else {
      pushEvent('ERROR', `Run failed: ${data.detail || JSON.stringify(data)}`, new Date().toISOString());
    }
  } catch(e) {
    pushEvent('ERROR', `Run error: ${e.message}`, new Date().toISOString());
  }
}

async function cancelMission(id) {
  try {
    const r = await fetch(API + `/v1/engine/missions/${id}`, {method:'DELETE'});
    const data = await r.json();
    if (data.ok !== false) {
      pushEvent('MISSION', `Cancelled mission ${id}`, new Date().toISOString());
      loadMissions();
    } else {
      pushEvent('ERROR', `Cancel failed: ${data.detail || JSON.stringify(data)}`, new Date().toISOString());
    }
  } catch(e) {
    pushEvent('ERROR', `Cancel mission error: ${e.message}`, new Date().toISOString());
  }
}

// â”€â”€ Vault â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVault() {
  const el = document.getElementById('artifact-list');
  const statsEl = document.getElementById('vault-stats');
  const statusFilter = document.getElementById('vault-status-filter').value;
  const typeFilter = document.getElementById('vault-type-filter').value;
  el.innerHTML = '<div class="loading">syncing vault streamâ€¦</div>';
  try {
    const params = new URLSearchParams({limit: '40'});
    if (statusFilter) params.set('status', statusFilter);
    if (typeFilter) params.set('type', typeFilter);

    const [listR, statsR] = await Promise.all([
      fetch(API + '/v1/vault/artifacts?' + params),
      fetch(API + '/v1/vault/stats')
    ]);
    const listData = await listR.json();
    const statsData = await statsR.json();

    const artifacts = listData.artifacts || [];
    if (statsData.ok) {
      const pending = statsData.pending_review || 0;
      statsEl.textContent = `${statsData.total || 0} total Â· ${pending} pending review`;
      updateNotifDot('notif-vault', pending);
    }

    el.innerHTML = artifacts.length ? artifacts.map(renderArtifactRow).join('') :
      '<div class="empty">No artifacts in this filter lane</div>';
  } catch(e) {
    el.innerHTML = `<div class="error-msg">Vault stream failed to load: ${e.message}</div>`;
  }
}

function renderArtifactRow(a) {
  const contentPreview = typeof a.content === 'string'
    ? a.content.slice(0, 120)
    : JSON.stringify(a.content).slice(0, 120);
  const isPending = a.status === 'PENDING_REVIEW';

  return `
    <div class="artifact-row">
      <div class="artifact-top">
        <span class="type-badge">${a.type}</span>
        <span class="artifact-title">${a.title}</span>
        <span class="status-badge s-${a.status}" style="flex-shrink:0">${a.status.replace('_',' ')}</span>
        ${a.version > 1 ? `<span style="font-size:9px;color:var(--dim)">v${a.version}</span>` : ''}
      </div>
      <div class="artifact-preview">${contentPreview}</div>
      <div style="font-size:9px;color:var(--dim);margin-top:4px">${fmtDate(a.created_at)}</div>
      ${isPending ? `
      <div class="artifact-actions">
        <button class="btn success" style="font-size:9px;padding:4px 10px" onclick="approveArtifact('${a.id}')">APPROVE</button>
        <button class="btn danger" style="font-size:9px;padding:4px 10px" onclick="rejectArtifact('${a.id}')">REJECT</button>
      </div>` : ''}
    </div>`;
}

async function approveArtifact(id) {
  try {
    const r = await fetch(API + `/v1/vault/artifacts/${id}/approve`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: '{}'
    });
    const data = await r.json();
    if (data.ok) {
      pushEvent('VAULT', `Approved artifact ${id.slice(0,8)}`, new Date().toISOString());
      loadVault();
    } else {
      pushEvent('ERROR', `Approve failed: ${data.detail}`, new Date().toISOString());
    }
  } catch(e) {
    pushEvent('ERROR', `Approve error: ${e.message}`, new Date().toISOString());
  }
}

async function rejectArtifact(id) {
  try {
    const r = await fetch(API + `/v1/vault/artifacts/${id}/reject`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: '{}'
    });
    const data = await r.json();
    if (data.ok) {
      pushEvent('VAULT', `Rejected artifact ${id.slice(0,8)}`, new Date().toISOString());
      loadVault();
    } else {
      pushEvent('ERROR', `Reject failed: ${data.detail}`, new Date().toISOString());
    }
  } catch(e) {
    pushEvent('ERROR', `Reject error: ${e.message}`, new Date().toISOString());
  }
}

// â”€â”€ Cognition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCognition() {
  try {
    const r = await fetch(API + '/v1/cognition/status');
    const data = await r.json();
    if (!data.ok) throw new Error(data.detail || 'failed');

    const preds = data.predictions || {};
    document.getElementById('cog-predictions').textContent = preds.total || 0;
    const brier = preds.avg_brier_score ?? preds.avg_brier ?? 'â€”';
    document.getElementById('cog-brier').textContent = 'Brier ' + (typeof brier === 'number' ? brier.toFixed(3) : 'â€”');

    const errs = data.errors || {};
    document.getElementById('cog-errors').textContent = errs.total || 0;
    document.getElementById('cog-dominant-error').textContent = 'Dominant ' + (errs.dominant_type || 'â€”');

    const decisions = data.decisions || {};
    document.getElementById('cog-autopsies').textContent = decisions.autopsies || decisions.total_autopsies || 0;
    document.getElementById('cog-decisions').textContent = 'Decisions ' + (decisions.total || decisions.total_classified || 'â€”');
  } catch(e) {
    document.getElementById('cog-predictions').textContent = 'â€”';
    pushEvent('ERROR', 'Cognition load failed: ' + e.message, new Date().toISOString());
  }
}

async function logPrediction() {
  const claim = document.getElementById('pred-claim').value.trim();
  const confidence = parseFloat(document.getElementById('pred-confidence').value);
  const category = document.getElementById('pred-category').value.trim() || 'GENERAL';
  const resultEl = document.getElementById('pred-result');
  if (!claim || isNaN(confidence)) {
    resultEl.textContent = 'Claim and confidence are required.';
    resultEl.style.color = 'var(--red)';
    return;
  }
  try {
    const r = await fetch(API + '/v1/cognition/predictions', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({claim, confidence, category})
    });
    const data = await r.json();
    if (data.ok) {
      resultEl.textContent = 'Prediction logged âš¡';
      resultEl.style.color = 'var(--green)';
      document.getElementById('pred-claim').value = '';
      document.getElementById('pred-confidence').value = '';
      pushEvent('COGNITION', `Prediction logged: ${claim.slice(0,40)}`, new Date().toISOString());
      setTimeout(() => loadCognition(), 400);
    } else {
      resultEl.textContent = 'Error: ' + (data.detail || JSON.stringify(data));
      resultEl.style.color = 'var(--red)';
    }
  } catch(e) {
    resultEl.textContent = 'Error: ' + e.message;
    resultEl.style.color = 'var(--red)';
  }
}

async function submitAutopsy() {
  const decision = document.getElementById('autopsy-decision').value.trim();
  const outcome = document.getElementById('autopsy-outcome').value.trim();
  const quality = parseFloat(document.getElementById('autopsy-quality').value);
  const resultEl = document.getElementById('autopsy-result');
  if (!decision || !outcome) {
    resultEl.textContent = 'Decision and outcome required.';
    resultEl.style.color = 'var(--red)';
    return;
  }
  try {
    const r = await fetch(API + '/v1/cognition/autopsy', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({decision, outcome, quality: isNaN(quality) ? 0.5 : quality})
    });
    const data = await r.json();
    if (data.ok) {
      resultEl.textContent = 'Autopsy submitted âš¡';
      resultEl.style.color = 'var(--green)';
      document.getElementById('autopsy-decision').value = '';
      document.getElementById('autopsy-outcome').value = '';
      document.getElementById('autopsy-quality').value = '';
      pushEvent('COGNITION', `Autopsy: ${decision.slice(0,40)}`, new Date().toISOString());
      setTimeout(() => loadCognition(), 400);
    } else {
      resultEl.textContent = 'Error: ' + (data.detail || JSON.stringify(data));
      resultEl.style.color = 'var(--red)';
    }
  } catch(e) {
    resultEl.textContent = 'Error: ' + e.message;
    resultEl.style.color = 'var(--red)';
  }
}

// â”€â”€ Notification dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateNotifDot(id, count) {
  const el = document.getElementById(id);
  if (!el) return;
  if (count > 0) {
    el.textContent = count > 99 ? '99+' : count;
    el.classList.add('visible');
  } else {
    el.classList.remove('visible');
  }
}

async function updateNotifDots() {
  try {
    const [mR, vR] = await Promise.all([
      fetch(API + '/v1/engine/missions/stats'),
      fetch(API + '/v1/vault/stats')
    ]);
    const mData = await mR.json();
    const vData = await vR.json();
    if (mData.ok) updateNotifDot('notif-missions', (mData.by_status || {}).BLOCKED || 0);
    if (vData.ok) updateNotifDot('notif-vault', vData.pending_review || 0);
  } catch(e) {
    // silent â€” notif dots are best-effort
  }
}

// â”€â”€ Event log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pushEvent(type, msg, ts) {
  eventLog.unshift({type, msg, ts});
  if (eventLog.length > 80) eventLog.pop();
  renderEventLog();
}

function renderEventLog() {
  const el = document.getElementById('event-list');
  if (!eventLog.length) { el.innerHTML = '<div class="empty">awaiting signal eventsâ€¦</div>'; return; }
  el.innerHTML = eventLog.map(e => `
    <div class="event-item">
      <div class="event-type et-${e.type}">${e.type}</div>
      <div class="event-msg">${e.msg}</div>
      <div class="event-ts">${fmtDate(e.ts)}</div>
    </div>`).join('');
}

function fmtDate(iso) {
  if (!iso) return '';
  try { return new Date(iso).toLocaleTimeString(); } catch { return iso; }
}

// â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadAll();
setInterval(loadAll, 8000);
setInterval(loadWorkers, 5000);
setInterval(updateNotifDots, 15000);
</script>
</body>
</html>
