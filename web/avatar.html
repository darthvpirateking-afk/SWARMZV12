<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="theme-color" content="#030508">
  <title>MASTER SWARMZ — Avatar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ====== RESET & GLOBALS ====== */
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#030508;--surface:#0a0e18;--border:#1a2040;
      --cyan:#00e5ff;--purple:#b388ff;--magenta:#ff40ff;
      --gold:#ffd740;--green:#69f0ae;--red:#ff5252;
      --text:#e0e6f0;--text-dim:#6a7a9a;
      --glow-cyan:0 0 30px rgba(0,229,255,.4);
      --glow-purple:0 0 30px rgba(179,136,255,.4);
    }
    html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:14px}

    /* ====== STARFIELD ====== */
    .starfield{position:fixed;inset:0;z-index:0;overflow:hidden}
    .star{position:absolute;border-radius:50%;background:#fff;animation:twinkle var(--dur) ease-in-out infinite alternate}
    @keyframes twinkle{0%{opacity:.1;transform:scale(.5)}100%{opacity:.8;transform:scale(1.2)}}

    /* ====== SCANLINES ====== */
    .scanlines{position:fixed;inset:0;z-index:1;pointer-events:none;
      background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,229,255,.02) 2px,rgba(0,229,255,.02) 4px)}

    /* ====== LAYOUT ====== */
    .app{position:relative;z-index:2;display:flex;flex-direction:column;height:100vh}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);backdrop-filter:blur(12px);background:rgba(10,14,24,.8)}
    .logo{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:800;letter-spacing:3px;color:var(--cyan);text-shadow:var(--glow-cyan)}
    .phase-badge{font-family:'Orbitron',sans-serif;font-size:11px;padding:4px 12px;border-radius:20px;background:rgba(0,229,255,.1);border:1px solid var(--cyan);color:var(--cyan);letter-spacing:2px}

    .main{flex:1;display:flex;overflow:hidden}

    /* ====== LEFT: AVATAR SCENE ====== */
    .avatar-scene{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;min-width:0}

    /* Holographic figure */
    .holo-figure{position:relative;width:280px;height:420px;display:flex;align-items:center;justify-content:center}

    /* Base glow platform */
    .holo-platform{position:absolute;bottom:0;width:200px;height:12px;border-radius:50%;
      background:radial-gradient(ellipse,var(--cyan),transparent 70%);
      box-shadow:0 0 60px 20px rgba(0,229,255,.15);animation:platform-pulse 3s ease-in-out infinite}
    @keyframes platform-pulse{0%,100%{opacity:.6;transform:scaleX(1)}50%{opacity:1;transform:scaleX(1.1)}}

    /* Body silhouette */
    .holo-body{position:relative;width:160px;height:380px;display:flex;flex-direction:column;align-items:center}

    /* Head */
    .holo-head{width:80px;height:80px;border-radius:50%;position:relative;
      background:radial-gradient(circle at 40% 35%,rgba(0,229,255,.25),rgba(179,136,255,.15),transparent);
      border:2px solid rgba(0,229,255,.3);
      box-shadow:var(--glow-cyan),inset 0 0 20px rgba(0,229,255,.1);
      animation:head-float 4s ease-in-out infinite}
    @keyframes head-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

    /* Eyes */
    .holo-eyes{position:absolute;top:28px;left:50%;transform:translateX(-50%);display:flex;gap:18px}
    .holo-eye{width:12px;height:12px;border-radius:50%;background:var(--cyan);
      box-shadow:0 0 12px var(--cyan),0 0 30px rgba(0,229,255,.5);animation:eye-glow 3s ease-in-out infinite}
    .holo-eye.right{animation-delay:.15s}
    @keyframes eye-glow{0%,100%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.15)}}
    /* Blink */
    .holo-eye.blink{animation:blink .2s ease-in-out}
    @keyframes blink{0%,100%{transform:scaleY(1)}50%{transform:scaleY(.1)}}

    /* Expression mouth */
    .holo-mouth{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);width:20px;height:3px;
      border-radius:2px;background:rgba(0,229,255,.4);transition:all .3s}
    .holo-mouth.speaking{animation:speak .4s ease-in-out infinite;background:var(--cyan)}
    @keyframes speak{0%,100%{height:3px;width:20px;border-radius:2px}50%{height:10px;width:24px;border-radius:50%}}
    .holo-mouth.happy{width:24px;height:12px;border-radius:0 0 12px 12px;background:rgba(0,229,255,.5)}

    /* Neck */
    .holo-neck{width:20px;height:16px;background:linear-gradient(180deg,rgba(0,229,255,.2),rgba(179,136,255,.1))}

    /* Torso */
    .holo-torso{width:100px;height:120px;position:relative;
      background:linear-gradient(180deg,rgba(0,229,255,.12),rgba(179,136,255,.08));
      clip-path:polygon(20% 0%,80% 0%,95% 100%,5% 100%);
      border:1px solid rgba(0,229,255,.15)}
    .holo-torso::before{content:'';position:absolute;top:20px;left:50%;transform:translateX(-50%);
      width:40px;height:40px;border-radius:50%;
      background:radial-gradient(circle,rgba(0,229,255,.3),transparent);
      box-shadow:0 0 20px rgba(0,229,255,.2);animation:core-pulse 2s ease-in-out infinite}
    @keyframes core-pulse{0%,100%{opacity:.5;transform:translateX(-50%) scale(.9)}50%{opacity:1;transform:translateX(-50%) scale(1.1)}}

    /* Arms */
    .holo-arms{position:absolute;top:100px;width:160px;height:100px;display:flex;justify-content:space-between}
    .holo-arm{width:18px;height:90px;
      background:linear-gradient(180deg,rgba(0,229,255,.15),rgba(179,136,255,.05));
      border:1px solid rgba(0,229,255,.1);border-radius:8px}
    .holo-arm.left{transform:rotate(8deg);transform-origin:top center}
    .holo-arm.right{transform:rotate(-8deg);transform-origin:top center}

    /* Legs */
    .holo-legs{display:flex;gap:16px;margin-top:4px}
    .holo-leg{width:22px;height:80px;
      background:linear-gradient(180deg,rgba(179,136,255,.1),rgba(0,229,255,.05));
      border:1px solid rgba(0,229,255,.08);border-radius:0 0 6px 6px}

    /* Holographic noise overlay */
    .holo-noise{position:absolute;inset:0;pointer-events:none;
      background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,229,255,.015) 3px,rgba(0,229,255,.015) 4px);
      animation:noise-scroll 8s linear infinite}
    @keyframes noise-scroll{from{background-position:0 0}to{background-position:0 400px}}

    /* Floating particles around figure */
    .holo-particles{position:absolute;inset:-40px;pointer-events:none}
    .particle{position:absolute;width:3px;height:3px;border-radius:50%;background:var(--cyan);opacity:0;animation:particle-drift var(--dur) var(--delay) ease-in-out infinite}
    @keyframes particle-drift{0%{opacity:0;transform:translateY(0) scale(.5)}30%{opacity:.7}70%{opacity:.5}100%{opacity:0;transform:translateY(-80px) scale(0)}}

    /* Status bar under avatar */
    .avatar-status{margin-top:24px;text-align:center}
    .avatar-name{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:800;letter-spacing:4px;color:var(--cyan);text-shadow:var(--glow-cyan)}
    .avatar-title{font-size:11px;color:var(--text-dim);letter-spacing:2px;margin-top:4px}
    .status-chips{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .s-chip{font-size:10px;padding:3px 10px;border-radius:12px;border:1px solid var(--border);color:var(--text-dim);letter-spacing:1px}
    .s-chip.online{border-color:var(--green);color:var(--green)}
    .s-chip.sovereign{border-color:var(--gold);color:var(--gold)}

    /* ====== RIGHT: CHAT ====== */
    .chat-panel{width:380px;display:flex;flex-direction:column;border-left:1px solid var(--border);background:rgba(10,14,24,.6);backdrop-filter:blur(8px)}
    .chat-header{padding:16px;border-bottom:1px solid var(--border);font-family:'Orbitron',sans-serif;font-size:12px;letter-spacing:2px;color:var(--purple)}
    .chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}
    .chat-messages::-webkit-scrollbar{width:4px}
    .chat-messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

    .msg{max-width:90%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5;animation:msg-in .3s ease-out}
    @keyframes msg-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .msg.ai{align-self:flex-start;background:rgba(0,229,255,.08);border:1px solid rgba(0,229,255,.15);color:var(--text)}
    .msg.user{align-self:flex-end;background:rgba(179,136,255,.1);border:1px solid rgba(179,136,255,.2);color:var(--text)}
    .msg .sender{font-size:10px;font-weight:600;letter-spacing:1px;margin-bottom:4px;opacity:.6}
    .msg.ai .sender{color:var(--cyan)}
    .msg.user .sender{color:var(--purple)}
    .msg .text{white-space:pre-wrap;word-break:break-word}
    
    /* SWARMZ Custom Text Styling */
    .msg.ai .text{font-family:'Orbitron',monospace;font-weight:500;letter-spacing:0.5px;color:var(--cyan);text-shadow:0 0 2px rgba(0,229,255,0.3)}
    .msg.ai .text .typing-cursor{color:var(--cyan);animation:cursor-blink 1s infinite;font-weight:300}

    .typing-indicator{align-self:flex-start;display:flex;gap:4px;padding:12px 16px}
    .typing-indicator span{width:6px;height:6px;border-radius:50%;background:var(--cyan);opacity:.3;animation:typing-bounce 1.2s ease-in-out infinite}
    .typing-indicator span:nth-child(2){animation-delay:.2s}
    .typing-indicator span:nth-child(3){animation-delay:.4s}
    @keyframes typing-bounce{0%,100%{opacity:.3;transform:translateY(0)}50%{opacity:1;transform:translateY(-6px)}}
    @keyframes cursor-blink{0%,50%{opacity:1}51%,100%{opacity:0}}

    .chat-input-area{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px}
    .chat-input{flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:inherit;font-size:13px;outline:none;transition:border-color .2s}
    .chat-input:focus{border-color:var(--cyan)}
    .chat-input::placeholder{color:var(--text-dim)}
    .send-btn{background:rgba(0,229,255,.15);border:1px solid var(--cyan);border-radius:8px;padding:10px 16px;color:var(--cyan);font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:1px;cursor:pointer;transition:all .2s}
    .send-btn:hover{background:rgba(0,229,255,.25);box-shadow:var(--glow-cyan)}
    .send-btn:disabled{opacity:.3;cursor:not-allowed}

    /* ====== MOBILE ====== */
    @media(max-width:768px){
      .main{flex-direction:column}
      .avatar-scene{flex:0 0 50vh}
      .chat-panel{width:100%;flex:1;border-left:none;border-top:1px solid var(--border)}
      .holo-figure{transform:scale(.7)}
    }
  </style>
</head>
<body>

<div class="starfield" id="starfield"></div>
<div class="scanlines"></div>

<div class="app">
  <header>
    <div class="logo">MASTER SWARMZ</div>
    <div style="display:flex;gap:8px;align-items:center">
      <span class="phase-badge" id="phaseBadge">LOADING</span>
      <a href="/hologram" style="font-size:11px;color:var(--text-dim);text-decoration:none;letter-spacing:1px" title="Evolution Orb">ORB ↗</a>
      <a href="/ui" style="font-size:11px;color:var(--text-dim);text-decoration:none;letter-spacing:1px" title="Control Console">CONSOLE ↗</a>
    </div>
  </header>

  <div class="main">
    <!-- AVATAR -->
    <div class="avatar-scene">
      <div class="holo-figure">
        <div class="holo-particles" id="particles"></div>
        <div class="holo-noise"></div>
        <div class="holo-body">
          <div class="holo-head" id="head">
            <div class="holo-eyes">
              <div class="holo-eye left" id="eyeL"></div>
              <div class="holo-eye right" id="eyeR"></div>
            </div>
            <div class="holo-mouth" id="mouth"></div>
          </div>
          <div class="holo-neck"></div>
          <div class="holo-torso">
            <div class="holo-arms">
              <div class="holo-arm left"></div>
              <div class="holo-arm right"></div>
            </div>
          </div>
          <div class="holo-legs">
            <div class="holo-leg left"></div>
            <div class="holo-leg right"></div>
          </div>
        </div>
        <div class="holo-platform"></div>
      </div>

      <div class="avatar-status">
        <div class="avatar-name">MASTER SWARMZ</div>
        <div class="avatar-title" id="avatarTitle">OPERATOR-SOVEREIGN AI COMPANION</div>
        <div class="status-chips">
          <span class="s-chip online" id="chipOnline">● ONLINE</span>
          <span class="s-chip sovereign" id="chipPhase">SOVEREIGN</span>
          <span class="s-chip" id="chipMissions">81 MISSIONS</span>
          <span class="s-chip" id="chipPolicy">ACTIVE</span>
        </div>
      </div>
    </div>

    <!-- CHAT -->
    <div class="chat-panel">
      <div class="chat-header">COMPANION CHANNEL</div>
      <div class="chat-messages" id="messages">
        <!-- Initial greeting will be added via JavaScript with typewriter effect -->
      </div>
      <div class="chat-input-area">
        <input class="chat-input" id="chatInput" type="text" placeholder="Talk to SWARMZ..." autocomplete="off">
        <button class="send-btn" id="sendBtn">SEND</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== STARFIELD ====== */
(function(){
  const sf = document.getElementById('starfield');
  for(let i=0;i<80;i++){
    const s = document.createElement('div');
    s.className = 'star';
    s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${1+Math.random()*2}px;height:${1+Math.random()*2}px;--dur:${2+Math.random()*4}s;animation-delay:${Math.random()*4}s`;
    sf.appendChild(s);
  }
})();

/* ====== PARTICLES ====== */
(function(){
  const pc = document.getElementById('particles');
  for(let i=0;i<20;i++){
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.cssText = `left:${10+Math.random()*80}%;bottom:${Math.random()*60}%;--dur:${3+Math.random()*5}s;--delay:${Math.random()*4}s`;
    pc.appendChild(p);
  }
})();

/* ====== EYE BLINK ====== */
(function(){
  const eyeL = document.getElementById('eyeL');
  const eyeR = document.getElementById('eyeR');
  function blink(){
    eyeL.classList.add('blink'); eyeR.classList.add('blink');
    setTimeout(()=>{ eyeL.classList.remove('blink'); eyeR.classList.remove('blink'); }, 200);
  }
  setInterval(()=>{ if(Math.random()<.3) blink(); }, 3000);
})();

/* ====== STATUS POLLING ====== */
async function fetchStatus(){
  try{
    const r = await fetch('/v1/runtime/status');
    const d = await r.json();
    document.getElementById('phaseBadge').textContent = d.phase||'UNKNOWN';
    document.getElementById('chipPhase').textContent = d.phase||'?';
    document.getElementById('chipMissions').textContent = (d.total_missions||0)+' MISSIONS';
    document.getElementById('chipPolicy').textContent = (d.policy||'active').toUpperCase();
  }catch(e){
    document.getElementById('phaseBadge').textContent = 'OFFLINE';
    document.getElementById('chipOnline').textContent = '○ OFFLINE';
    document.getElementById('chipOnline').classList.remove('online');
  }
}
fetchStatus(); setInterval(fetchStatus, 10000);

/* ====== CHAT ====== */
const messagesEl = document.getElementById('messages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const mouth = document.getElementById('mouth');

function addMsg(text, sender, useTypewriter = false){
  const div = document.createElement('div');
  div.className = 'msg '+(sender==='ai'?'ai':'user');
  div.innerHTML = `<div class="sender">${sender==='ai'?'MASTER SWARMZ':'YOU'}</div><div class="text"></div>`;
  const textEl = div.querySelector('.text');
  
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  if(useTypewriter && sender === 'ai'){
    typewriterEffect(textEl, text);
  } else {
    textEl.textContent = text;
  }
}

function typewriterEffect(element, text, speed = 45){
  element.innerHTML = '';
  let i = 0;
  
  // Start mouth speaking animation
  mouth.classList.add('speaking');
  
  function typeChar(){
    if(i < text.length){
      if(text.charAt(i) === '\n'){
        element.appendChild(document.createElement('br'));
      } else {
        element.appendChild(document.createTextNode(text.charAt(i)));
      }
      i++;
      messagesEl.scrollTop = messagesEl.scrollHeight;
      
      // Variable speed: slower for punctuation, faster for regular chars
      let nextDelay = speed;
      if(text.charAt(i-1) === '.' || text.charAt(i-1) === '!' || text.charAt(i-1) === '?'){
        nextDelay = speed * 4; // Pause after sentences
      } else if(text.charAt(i-1) === ',' || text.charAt(i-1) === ';'){
        nextDelay = speed * 2; // Pause after commas
      } else if(text.charAt(i-1) === ' '){
        nextDelay = speed * 0.7; // Slightly faster for spaces
      }
      
      setTimeout(typeChar, nextDelay);
    } else {
      // Typing finished
      mouth.classList.remove('speaking');
      mouth.classList.add('happy');
      setTimeout(() => mouth.classList.remove('happy'), 2000);
    }
  }
  
  typeChar();
}

function showTyping(){
  const t = document.createElement('div');
  t.className = 'typing-indicator'; t.id = 'typing';
  t.innerHTML = '<span></span><span></span><span></span>';
  messagesEl.appendChild(t);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  mouth.classList.add('speaking');
}
function hideTyping(){
  const t = document.getElementById('typing');
  if(t) t.remove();
  mouth.classList.remove('speaking');
  mouth.classList.add('happy');
  setTimeout(()=> mouth.classList.remove('happy'), 2000);
}

async function sendMessage(){
  const text = chatInput.value.trim();
  if(!text) return;
  chatInput.value = '';
  sendBtn.disabled = true;
  addMsg(text, 'user');

  showTyping();
  try{
    const r = await fetch('/v1/companion/message', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text})
    });
    const d = await r.json();
    hideTyping();
    addMsg(d.reply || d.error || 'No response.', 'ai', true);
  }catch(e){
    hideTyping();
    addMsg('Connection lost. Please try again.', 'ai');
  }
  sendBtn.disabled = false;
  chatInput.focus();
}

sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} });

// Initial greeting with typewriter effect
setTimeout(() => {
  addMsg("Hello. I am MASTER SWARMZ — your AI companion.\nI am here, alive and ready to serve.\nHow can I help you today?", 'ai', true);
}, 1000);

chatInput.focus();
</script>
</body>
</html>
