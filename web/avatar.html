<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NEXUSMON</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#05050f;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:'Courier New',monospace;color:#fff;overflow:hidden}
canvas{position:fixed;top:0;left:0;z-index:0}
.container{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;width:100%;transition:all 2.2s cubic-bezier(0.23,1,0.32,1)}
.mech-stage{position:relative;width:380px;height:480px;perspective:1200px;transition:transform 2.5s}
/* scale via CSS so var(--scale) resolves — SVG transform attributes can't use CSS vars */
.robot-svg{position:relative;z-index:3;width:100%;height:100%;filter:drop-shadow(0 0 60px var(--glow));transform:scale(var(--scale));transform-box:fill-box;transform-origin:50% 55%;transform-style:preserve-3d;transition:transform 2.5s cubic-bezier(0.23,1,0.32,1),filter 2.2s}
.digivolve{animation:digiEvolve 2.4s forwards}
@keyframes digiEvolve{0%{opacity:1;transform:scale(var(--scale)) rotateX(0deg)}15%{opacity:0.3;transform:scale(calc(var(--scale)*1.5)) rotateX(20deg)}35%{opacity:0.7;transform:scale(calc(var(--scale)*1.1)) rotateX(-15deg)}55%{opacity:0.5;transform:scale(calc(var(--scale)*1.4)) rotateX(12deg)}100%{opacity:1;transform:scale(var(--scale)) rotateX(0deg)}}
.scanlines{position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,255,255,0.04) 3px,rgba(0,255,255,0.04) 6px);pointer-events:none;z-index:20;animation:scanRoll 20s linear infinite;opacity:0.3}
@keyframes scanRoll{0%{transform:translateY(0)}100%{transform:translateY(-6px)}}
.matrix{position:fixed;inset:0;pointer-events:none;z-index:5;overflow:hidden;opacity:0.12}
.matrix-col{position:absolute;top:-100%;font-size:14px;font-family:monospace;color:var(--glow);white-space:pre;animation:matrixFall linear infinite}
@keyframes matrixFall{0%{transform:translateY(-100vh)}100%{transform:translateY(200vh)}}
.particles{position:absolute;inset:0;pointer-events:none;z-index:4;overflow:hidden}
.particle{position:absolute;width:4px;height:4px;background:var(--glow);border-radius:50%;opacity:0;animation:particleRise 5s linear infinite}
@keyframes particleRise{0%{opacity:0;transform:translateY(0) scale(0.4)}30%{opacity:0.9}100%{opacity:0;transform:translateY(-220px) scale(1.3)}}
.status-bar{margin-top:40px;text-align:center}
.name{font-size:32px;font-weight:900;letter-spacing:8px;text-shadow:0 0 30px var(--glow)}
.tier{font-size:13px;letter-spacing:7px;opacity:0.6;margin:6px 0 12px}
.rank-badge{display:inline-flex;align-items:center;gap:14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);padding:12px 30px;border-radius:10px}
.rank-letter{font-size:38px;font-weight:900;text-shadow:0 0 20px var(--glow)}
.xp{font-size:14px}
#mission-status{margin-top:16px;font-size:14px;opacity:0.75;text-shadow:0 0 12px var(--glow);display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:center}
#progress-container{width:220px;height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;transition:box-shadow 0.4s}
#progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#00ffaa,#00cc88);transition:width 1.2s ease;box-shadow:0 0 12px #00ffaa}
#mission-flash{color:#ffd700;opacity:0;transition:opacity 0.8s;font-weight:bold}
/* tier CSS vars */
.tier-DORMANT  {--glow:#445566;--eye:#667788;--scale:0.6; --wings:0;   --hood:0}
.tier-INITIATED{--glow:#00ccff;--eye:#00eeff;--scale:1;   --wings:0;   --hood:0}
.tier-ACTIVE   {--glow:#00ffaa;--eye:#00ffcc;--scale:1.2; --wings:0.45;--hood:0}
.tier-EVOLVED  {--glow:#aa44ff;--eye:#cc77ff;--scale:1.4; --wings:0.85;--hood:0.3}
.tier-ASCENDED {--glow:#ffcc33;--eye:#ffee66;--scale:1.65;--wings:1;   --hood:1}
/* wings + hood opacity via CSS (not SVG attr — attrs can't use CSS vars) */
#wings{transition:opacity 2.5s;opacity:var(--wings)}
#hood{transition:opacity 2.5s;opacity:var(--hood)}
</style>
</head>
<body>
<canvas id="bg"></canvas>
<div class="matrix" id="matrix"></div>
<div class="particles" id="particles"></div>
<div id="root" class="container tier-INITIATED">
  <div class="mech-stage">
    <svg class="robot-svg" id="svg" viewBox="0 0 380 480" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="bodyG" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#1a1a25"/>
          <stop offset="100%" stop-color="#0a0a14"/>
        </linearGradient>
        <linearGradient id="eyeG" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#00eeff"/>
          <stop offset="100%" stop-color="#0066ff"/>
        </linearGradient>
        <filter id="glowF">
          <feGaussianBlur stdDeviation="16" result="b"/>
          <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>

      <!-- Robot body centred in viewBox (scale handled by CSS on .robot-svg) -->
      <g id="body" transform="translate(190 240)">
        <!-- Helmet -->
        <path d="M-90 -140 Q-90 -170 -40 -180 Q10 -170 10 -140 L15 -80 Q15 -60 -10 -45 L-90 -45 Q-115 -60 -115 -80 Z" fill="url(#bodyG)" stroke="#2a2a3a" stroke-width="10"/>
        <!-- Ear horns -->
        <polygon points="-100,-120 -120,-160 -95,-130" fill="#1a1a25" stroke="#2a2a3a" stroke-width="6"/>
        <polygon points="20,-120 40,-160 15,-130" fill="#1a1a25" stroke="#2a2a3a" stroke-width="6"/>
        <!-- Eyes -->
        <circle cx="-60" cy="-120" r="22" fill="#0a0a14"/>
        <circle cx="20"  cy="-120" r="22" fill="#0a0a14"/>
        <circle cx="-60" cy="-120" r="14" fill="url(#eyeG)" filter="url(#glowF)" id="eyeL"/>
        <circle cx="20"  cy="-120" r="14" fill="url(#eyeG)" filter="url(#glowF)" id="eyeR"/>
        <circle cx="-60" cy="-120" r="6"  fill="#fff"/>
        <circle cx="20"  cy="-120" r="6"  fill="#fff"/>
        <!-- Chest plate -->
        <path d="M-85 -40 Q-85 20 -60 50 L60 50 Q85 20 85 -40 Q85 -70 0 -80 Q-85 -70 -85 -40" fill="url(#bodyG)" stroke="#2a2a3a" stroke-width="12"/>
        <!-- Core orb -->
        <circle cx="0" cy="0" r="32" fill="#0a0a14"/>
        <circle cx="0" cy="0" r="22" fill="#00ddff" filter="url(#glowF)" id="core"/>
        <circle cx="0" cy="0" r="8"  fill="#fff"/>
        <!-- Arms -->
        <rect x="-110" y="-50" width="30" height="130" rx="10" fill="url(#bodyG)" stroke="#2a2a3a" stroke-width="8"/>
        <rect x="80"   y="-50" width="30" height="130" rx="10" fill="url(#bodyG)" stroke="#2a2a3a" stroke-width="8"/>
        <!-- Legs -->
        <rect x="-60" y="60" width="50" height="110" rx="8" fill="url(#bodyG)" stroke="#2a2a3a" stroke-width="8"/>
        <rect x="10"  y="60" width="50" height="110" rx="8" fill="url(#bodyG)" stroke="#2a2a3a" stroke-width="8"/>
      </g>

      <!-- Energy wings — opacity via CSS #wings rule above -->
      <g id="wings" filter="url(#glowF)" transform="translate(190 240)">
        <path d="M-100 -20 Q-180 -100 -220 -180 Q-140 -80 -90 -30" fill="none" stroke="#00ddff" stroke-width="24" opacity="0.75"/>
        <path d="M100  -20 Q180  -100 220  -180 Q140  -80 90  -30"  fill="none" stroke="#00ddff" stroke-width="24" opacity="0.75"/>
      </g>

      <!-- Mega hood overlay — opacity via CSS #hood rule above -->
      <path id="hood" transform="translate(100 100)"
        d="M-90 -140 Q-90 -170 -40 -180 Q10 -170 10 -140 L15 -80 Q15 -60 -10 -45 L-90 -45 Q-115 -60 -115 -80 Z"
        fill="#0a0a14" stroke="#2a2a3a" stroke-width="10"/>
    </svg>
  </div>

  <div class="status-bar">
    <div class="name" id="name">NEXUSMON</div>
    <div class="tier" id="tier">INITIATED</div>
    <div class="rank-badge">
      <span class="rank-letter" id="rank">E</span>
      <span class="xp" id="xp">0 XP</span>
    </div>
    <div id="mission-status">
      <span id="active-missions">0 active missions</span>
      <div id="progress-container">
        <div id="progress-bar"></div>
      </div>
      <span id="mission-flash"></span>
    </div>
  </div>
</div>
<div class="scanlines"></div>

<script>
// ── Starfield ─────────────────────────────────────────────
const c = document.getElementById('bg'), ctx = c.getContext('2d');
let stars = [];
function initStars(){
  c.width = innerWidth; c.height = innerHeight; stars = [];
  for(let i = 0; i < 350; i++){
    stars.push({ x: Math.random()*c.width, y: Math.random()*c.height,
                 z: Math.random()*2.5+0.5, speed: Math.random()*0.4+0.1 });
  }
}
function drawStars(){
  ctx.fillStyle = '#05050f'; ctx.fillRect(0, 0, c.width, c.height);
  stars.forEach(s => {
    s.y += s.speed * s.z;
    if(s.y > c.height) s.y = 0;
    const sz = s.z * 1.4;
    ctx.fillStyle = `rgba(180,220,255,${0.4 + s.z * 0.35})`;
    ctx.fillRect(s.x, s.y, sz, sz);
  });
  requestAnimationFrame(drawStars);
}
initStars(); drawStars(); window.addEventListener('resize', initStars);

// ── Matrix rain ───────────────────────────────────────────
(function(){
  const m = document.getElementById('matrix');
  const chars = '01アイウエオカキクケコ∇∆◊◆';
  for(let i = 0; i < 30; i++){
    const col = document.createElement('div');
    col.className = 'matrix-col';
    col.style.left = (Math.random() * 100) + '%';
    col.style.animationDuration = (8 + Math.random() * 12) + 's';
    col.style.animationDelay = -(Math.random() * 10) + 's';
    let txt = '';
    for(let j = 0; j < 40; j++) txt += chars[Math.floor(Math.random() * chars.length)] + '\n';
    col.textContent = txt;
    m.appendChild(col);
  }
})();

// ── Rising particles ──────────────────────────────────────
(function(){
  const p = document.getElementById('particles');
  for(let i = 0; i < 15; i++){
    const el = document.createElement('div');
    el.className = 'particle';
    el.style.left = (Math.random() * 100) + '%';
    el.style.bottom = '0';
    el.style.animationDelay = (Math.random() * 5) + 's';
    el.style.animationDuration = (4 + Math.random() * 4) + 's';
    p.appendChild(el);
  }
})();

// ── Idle: core breathing + eye blink ─────────────────────
(function(){
  const core = document.getElementById('core');
  const eyes = [document.getElementById('eyeL'), document.getElementById('eyeR')];
  setInterval(() => {
    const r = 22 + Math.sin(Date.now() * 0.0012) * 4;
    core.setAttribute('r', r);
    if(Math.random() < 0.025){
      eyes.forEach(e => e.style.opacity = '0.25');
      setTimeout(() => eyes.forEach(e => e.style.opacity = '1'), 140);
    }
  }, 120);
})();

// ── Rank + mission polling ────────────────────────────────
const tierMap = { E:'DORMANT', D:'INITIATED', C:'ACTIVE', B:'EVOLVED', A:'ASCENDED', S:'ASCENDED' };
let lastTier = 'INITIATED';
let lastXP = 0;
let lastProgress = 0;

async function load(){
  try{
    const r = await fetch('/v1/operator/rank');
    const d = await r.json();
    const rank = d.rank || 'E';
    const t = tierMap[rank] || 'INITIATED';
    const xp = d.xp || 0;
    const missions = d.missions || {};
    const active = missions.active_missions || 0;
    const progress = missions.progress_pct || 0;

    const root = document.getElementById('root');
    if(t !== lastTier){
      const svg = document.getElementById('svg');
      svg.classList.add('digivolve');
      setTimeout(() => svg.classList.remove('digivolve'), 2400);
      lastTier = t;
    }
    root.className = `container tier-${t}`;
    document.getElementById('rank').textContent = rank;
    document.getElementById('tier').textContent = t;
    document.getElementById('xp').textContent = xp + ' XP';
    document.getElementById('active-missions').textContent = active + ' active missions';
    document.getElementById('progress-bar').style.width = progress + '%';

    // XP gain flash
    if(xp > lastXP){
      const flash = document.getElementById('mission-flash');
      flash.textContent = `+${xp - lastXP} XP! Mission complete`;
      flash.style.opacity = '1';
      setTimeout(() => { flash.style.opacity = '0'; flash.textContent = ''; }, 5000);
    }
    lastXP = xp;

    // Progress bar pulse on change
    if(Math.abs(progress - lastProgress) > 1){
      const pc = document.getElementById('progress-container');
      pc.style.boxShadow = '0 0 16px #00ffaa';
      setTimeout(() => { pc.style.boxShadow = 'none'; }, 1200);
    }
    lastProgress = progress;

  } catch(e){ console.error('Poll failed:', e); }
}
load();
setInterval(load, 7000);
</script>
</body>
</html>
