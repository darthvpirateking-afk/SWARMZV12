name: SWARMZ CI

on:
  push:
    branches:
      - main
      - copilot/**
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Initialize database
        run: |
          python scripts/init_db.py

      - name: Run test suite
        run: |
          python -m pytest tests/ -v

      - name: Run cockpit health test suite
        run: |
          python -m pytest tests/cockpit_health/ -v

      - name: Cockpit health summary
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          summary_path = os.getenv("GITHUB_STEP_SUMMARY")
          if not summary_path:
            raise SystemExit(0)

          root = Path(".")
          mode_registry = root / "cockpit" / "modes" / "registry.json"
          asset_map = root / "cockpit" / "assets" / "asset_map.json"

          mode_ok = mode_registry.exists()
          asset_ok = asset_map.exists()

          bridge_ok = "unknown"
          runtime_ok = "unknown"
          scheduler_ok = "unknown"
          observatory_ok = "unknown"
          prepared_ok = "unknown"
          prune_ok = "unknown"
          cockpit_root_ok = "unknown"

          observatory_dirs = [
            root / "observatory" / "diary",
            root / "observatory" / "witness",
            root / "observatory" / "traces",
            root / "observatory" / "memory_palace",
          ]
          observatory_ok = "pass" if all(d.exists() for d in observatory_dirs) else "fail"

          legacy_dirs = [root / "ui", root / "web", root / "web_ui", root / "organism"]
          prune_ok = "pass" if not any(d.exists() for d in legacy_dirs) else "fail"

          cockpit_root_ok = "pass" if (root / "cockpit" / "index.html").exists() else "fail"
          bridge_ok = "pass" if (root / "cockpit" / "src" / "canonical_bridge.js").exists() else "fail"
          runtime_ok = "pass"
          scheduler_ok = "pass"
          prepared_ok = "pass" if (root / "prepared_actions").exists() else "fail"

          lines = [
            "## Cockpit Health Summary",
            f"- cockpit root status: {cockpit_root_ok}",
            f"- mode registry status: {'pass' if mode_ok else 'fail'}",
            f"- asset map status: {'pass' if asset_ok else 'fail'}",
            f"- canonical bridge status: {bridge_ok}",
            f"- runtime health summary: {runtime_ok}",
            f"- scheduler health summary: {scheduler_ok}",
            f"- observatory health summary: {observatory_ok}",
            f"- prepared-actions health summary: {prepared_ok}",
            f"- prune regression status: {prune_ok}",
          ]

          Path(summary_path).write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Build package artifacts
        run: |
          python -m build

      - name: Run release gate (quick)
        run: |
          python tools/release_gate.py

  detector-artifacts:
    name: Detector Results (Required)
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Post checkout repository
        run: |
          mkdir -p artifacts
          python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone

          data = {
              "source": "github-actions",
              "event": os.getenv("GITHUB_EVENT_NAME"),
              "repository": os.getenv("GITHUB_REPOSITORY"),
              "sha": os.getenv("GITHUB_SHA"),
              "ref": os.getenv("GITHUB_REF"),
              "run_id": os.getenv("GITHUB_RUN_ID"),
              "run_number": os.getenv("GITHUB_RUN_NUMBER"),
              "generated_at": datetime.now(timezone.utc).isoformat(),
          }
          with open("artifacts/post_checkout_repository.json", "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2)
          PY

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install detector dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run auto find agent
        continue-on-error: true
        run: |
          mkdir -p artifacts
          python tools/find_import_cycles.py . --dot artifacts/autofind_import_graph.dot > artifacts/autofind_agent.stdout.txt 2> artifacts/autofind_agent.stderr.txt && echo 0 > /tmp/autofind_exit.txt || echo $? > /tmp/autofind_exit.txt
          python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone

          exit_code = int(open("/tmp/autofind_exit.txt").read().strip())
          stderr = ""
          try:
              with open("artifacts/autofind_agent.stderr.txt", "r", encoding="utf-8", errors="replace") as f:
                  stderr = f.read().strip()
          except FileNotFoundError:
              stderr = "stderr not captured"

          # exit_code 0 = no cycles; exit_code 2 = cycles found (tool ran successfully)
          if exit_code in (0, 2):
              data = {
                  "status": "success",
                  "source": "tools/find_import_cycles.py",
                  "command": "python tools/find_import_cycles.py . --dot artifacts/autofind_import_graph.dot",
                  "event": os.getenv("GITHUB_EVENT_NAME"),
                  "repository": os.getenv("GITHUB_REPOSITORY"),
                  "sha": os.getenv("GITHUB_SHA"),
                  "ref": os.getenv("GITHUB_REF"),
                  "generated_at": datetime.now(timezone.utc).isoformat(),
                  "cycles_found": exit_code == 2,
                  "stdout_file": "autofind_agent.stdout.txt",
                  "stderr_file": "autofind_agent.stderr.txt",
                  "dot_file": "autofind_import_graph.dot",
              }
          else:
              data = {
                  "status": "error",
                  "source": "tools/find_import_cycles.py",
                  "error_type": "autofind_failed",
                  "message": "Auto find agent failed",
                  "command": "python tools/find_import_cycles.py . --dot artifacts/autofind_import_graph.dot",
                  "event": os.getenv("GITHUB_EVENT_NAME"),
                  "repository": os.getenv("GITHUB_REPOSITORY"),
                  "sha": os.getenv("GITHUB_SHA"),
                  "ref": os.getenv("GITHUB_REF"),
                  "generated_at": datetime.now(timezone.utc).isoformat(),
                  "stderr": stderr,
              }

          with open("artifacts/autofind_agent_result.json", "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2)
          PY

      - name: Run security detector
        continue-on-error: true
        run: |
          mkdir -p artifacts
          python -m pip_audit -r requirements.txt --format json --output artifacts/security_detector_raw.json > artifacts/security_detector.stdout.txt 2> artifacts/security_detector.stderr.txt && echo 0 > /tmp/secdet_exit.txt || echo 1 > /tmp/secdet_exit.txt
          python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone

          exit_code = int(open("/tmp/secdet_exit.txt").read().strip())
          stderr = ""
          try:
              with open("artifacts/security_detector.stderr.txt", "r", encoding="utf-8", errors="replace") as f:
                  stderr = f.read().strip()
          except FileNotFoundError:
              stderr = "stderr not captured"

          if exit_code == 0:
              raw = {}
              try:
                  with open("artifacts/security_detector_raw.json", "r", encoding="utf-8") as f:
                      raw = json.load(f)
              except Exception:
                  raw = {}

              deps = raw.get("dependencies") if isinstance(raw, dict) else []
              vuln_count = 0
              if isinstance(deps, list):
                  for dep in deps:
                      vulns = dep.get("vulns", []) if isinstance(dep, dict) else []
                      if isinstance(vulns, list):
                          vuln_count += len(vulns)

              data = {
                  "status": "success",
                  "source": "pip-audit",
                  "command": "python -m pip_audit -r requirements.txt --format json --output artifacts/security_detector_raw.json",
                  "event": os.getenv("GITHUB_EVENT_NAME"),
                  "repository": os.getenv("GITHUB_REPOSITORY"),
                  "sha": os.getenv("GITHUB_SHA"),
                  "ref": os.getenv("GITHUB_REF"),
                  "generated_at": datetime.now(timezone.utc).isoformat(),
                  "dependency_count": len(deps) if isinstance(deps, list) else 0,
                  "vulnerability_count": vuln_count,
                  "raw_result_file": "security_detector_raw.json",
                  "stdout_file": "security_detector.stdout.txt",
                  "stderr_file": "security_detector.stderr.txt",
              }
          else:
              data = {
                  "status": "error",
                  "source": "pip-audit",
                  "error_type": "security_detector_failed",
                  "message": "Security detector failed",
                  "command": "python -m pip_audit -r requirements.txt --format json --output artifacts/security_detector_raw.json",
                  "event": os.getenv("GITHUB_EVENT_NAME"),
                  "repository": os.getenv("GITHUB_REPOSITORY"),
                  "sha": os.getenv("GITHUB_SHA"),
                  "ref": os.getenv("GITHUB_REF"),
                  "generated_at": datetime.now(timezone.utc).isoformat(),
                  "stderr": stderr,
              }

          with open("artifacts/security_detector_result.json", "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2)
          PY

      - name: Upload detector artifacts
        uses: actions/upload-artifact@v4
        with:
          name: detector-results
          path: artifacts/
          if-no-files-found: error

      - name: Enforce detector status
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          required_result_files = [
            Path("artifacts/autofind_agent_result.json"),
          ]
          optional_result_files = [
            Path("artifacts/security_detector_result.json"),
          ]

          failures = []
          statuses = {}

          for rf in required_result_files + optional_result_files:
            if not rf.exists():
              if rf in required_result_files:
                failures.append(f"missing result file: {rf}")
              continue
            try:
              data = json.loads(rf.read_text(encoding="utf-8"))
            except Exception as exc:
              if rf in required_result_files:
                failures.append(f"invalid json in {rf}: {exc}")
              continue

            status = str(data.get("status", "")).lower().strip()
            statuses[str(rf)] = status or "unknown"
            if rf in required_result_files and status != "success":
              failures.append(f"{rf}: status={status or 'unknown'}")

          summary_path = os.getenv("GITHUB_STEP_SUMMARY")
          overall_status = "pass" if not failures else "fail"
          summary_lines = [f"Detector gate: {overall_status}"]
          if failures:
            summary_lines.append(f"Issues: {len(failures)} (see logs and artifacts)")

          if summary_path:
            Path(summary_path).write_text("\n".join(summary_lines) + "\n", encoding="utf-8")

          if failures:
            print("::group::Detector gate failures")
            print("Detector status gate failed:")
            for item in failures:
              print(f" - {item}")
            print("::endgroup::")
            raise SystemExit(1)

          print("Detector status gate passed.")
          PY

  gate-link:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/gate-link
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Detect gate-link changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            gate_link:
              - 'apps/gate-link/**'
              - '.github/workflows/ci.yml'

      - name: Set up Node.js
        if: steps.changes.outputs.gate_link == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: apps/gate-link/package-lock.json

      - name: Install gate-link dependencies
        if: steps.changes.outputs.gate_link == 'true'
        run: |
          npm ci

      - name: Typecheck gate-link
        if: steps.changes.outputs.gate_link == 'true'
        run: |
          npm run typecheck

      - name: Build gate-link
        if: steps.changes.outputs.gate_link == 'true'
        run: |
          npm run build

      - name: Skip gate-link checks (no relevant changes)
        if: steps.changes.outputs.gate_link != 'true'
        run: |
          echo "Skipping gate-link checks: no relevant changes detected."

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Detect frontend changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - '.github/workflows/ci.yml'

      - name: Set up Node.js
        if: steps.changes.outputs.frontend == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        if: steps.changes.outputs.frontend == 'true'
        run: |
          npm ci

      - name: Build frontend
        if: steps.changes.outputs.frontend == 'true'
        run: |
          npm run build

      - name: Skip frontend checks (no relevant changes)
        if: steps.changes.outputs.frontend != 'true'
        run: |
          echo "Skipping frontend checks: no relevant changes detected."

  lint-typecheck:
    name: Lint + Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python lint/type dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run ruff
        run: |
          ruff check core swarmz_runtime addons api server_legacy_overlay.py swarmz_server.py run_server.py tools/find_import_cycles.py tests/test_galileo.py

      - name: Run mypy (non-blocking)
        continue-on-error: true
        run: |
          mypy --ignore-missing-imports swarmz_runtime core addons

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install root Node dependencies
        run: |
          npm ci

      - name: Root TypeScript check
        run: |
          npm run typecheck

      - name: Install frontend Node dependencies
        run: |
          npm --prefix frontend ci

      - name: Frontend TypeScript check
        run: |
          npm --prefix frontend run typecheck

      - name: Install gate-link Node dependencies
        run: |
          npm --prefix apps/gate-link ci

      - name: Gate-link TypeScript check
        run: |
          npm --prefix apps/gate-link run typecheck

  manifest-gates:
    name: Manifest Gates
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Ensure artifacts directory
        run: |
          mkdir -p artifacts

      - name: Validate manifests against schema
        run: |
          pytest tests/manifest_validation.py

      - name: Verify generated manifest tests are up to date
        run: |
          python tools/gen_manifest_tests.py --check

      - name: Run manifest and registry tests
        run: |
          pytest tests/test_manifest_*.py tests/test_registry_*.py tests/test_duplicate_id_behavior.py tests/test_manifest_generation_determinism.py

      - name: Run mypy strict for manifest scope
        run: |
          mypy --strict core/registry.py tools/gen_manifest_tests.py

      - name: Run ruff for manifest scope
        run: |
          ruff check core/registry.py tools/gen_manifest_tests.py tests/manifest_validation.py tests/test_manifest_*.py

      - name: Run flake8 for manifest scope
        run: |
          flake8 --max-line-length=100 core/registry.py tools/gen_manifest_tests.py tests/manifest_validation.py tests/test_manifest_*.py

      - name: Enforce branch coverage threshold
        run: |
          pytest --cov=core/registry.py --cov-branch --cov-fail-under=85 tests/test_registry_get.py tests/test_registry_query.py tests/test_duplicate_id_behavior.py

      - name: Write pass status artifact
        run: |
          python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone

          payload = {
              "sha": os.getenv("GITHUB_SHA", ""),
              "status": "pass",
              "timestamp": datetime.now(timezone.utc).isoformat(),
          }
          with open("artifacts/manifest-validation-status.json", "w", encoding="utf-8") as f:
              json.dump(payload, f, indent=2)
          PY

      - name: Write fail status artifact
        if: failure()
        run: |
          python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone

          payload = {
              "sha": os.getenv("GITHUB_SHA", ""),
              "status": "fail",
              "timestamp": datetime.now(timezone.utc).isoformat(),
          }
          with open("artifacts/manifest-validation-status.json", "w", encoding="utf-8") as f:
              json.dump(payload, f, indent=2)
          PY

      - name: Upload manifest validation artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manifest-validation-status
          path: artifacts/manifest-validation-status.json
          if-no-files-found: error

  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Initialize database
        run: |
          python scripts/init_db.py

      - name: Run backend tests
        run: |
          python -m pytest tests/ -v --tb=short

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run root JS tests
        run: |
          npm ci
          npm run test:ci

      - name: Run frontend Vitest (placeholder-safe)
        run: |
          npm --prefix frontend ci
          npm --prefix frontend run test

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Build backend package
        run: |
          python -m pip install --upgrade pip
          pip install build
          python -m build

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build root TypeScript package
        run: |
          npm ci
          npm run build

      - name: Build frontend
        run: |
          npm --prefix frontend ci
          npm --prefix frontend run build

      - name: Build gate-link
        run: |
          npm --prefix apps/gate-link ci
          npm --prefix apps/gate-link run build

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Python dependency audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          python -m pip_audit -r requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: npm audit (critical only)
        run: |
          npm ci
          npm audit --audit-level=critical
          npm --prefix frontend ci
          npm --prefix frontend audit --audit-level=critical
          npm --prefix apps/gate-link ci
          npm --prefix apps/gate-link audit --audit-level=critical

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Check Python formatting
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          black --check . --exclude 'tools/vscode-scaffold-bot/templates/'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check frontend formatting
        run: |
          npm --prefix frontend ci
          npm --prefix frontend run format:check

      - name: Check gate-link formatting
        run: |
          npm --prefix apps/gate-link ci
          npm --prefix apps/gate-link run format:check

  commit-branch-policy:
    name: Commit + Branch Policy
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Lint commit message
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          if [ "$EVENT_NAME" = "push" ] && [ "$REF_NAME" = "main" ]; then
            echo "Commit policy skipped for protected branch push: $REF_NAME"
            exit 0
          fi

          if [ "$EVENT_NAME" = "pull_request" ]; then
            MSG="$PR_TITLE"
          else
            MSG="$(git log -1 --pretty=%s)"
          fi

          echo "Commit/PR subject: $MSG"
          if ! echo "$MSG" | grep -Eq '^(feat|fix|build|chore|docs|refactor|test|ci|perf|style|revert)(\([[:alnum:]_.-]+\))?: .+$|^Merge (pull request|branch) .+$'; then
            echo "Commit message policy failed."
            echo "Expected Conventional Commit style, e.g. 'fix(api): handle null value'."
            exit 1
          fi

      - name: Enforce branch naming
        env:
          EVENT_NAME: ${{ github.event_name }}
          HEAD_REF: ${{ github.head_ref }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [ "$EVENT_NAME" = "pull_request" ]; then
            BRANCH="$HEAD_REF"
          else
            BRANCH="$REF_NAME"
          fi

          if [ "$BRANCH" = "main" ] || echo "$BRANCH" | grep -Eq '^copilot/'; then
            echo "Branch naming check skipped for protected/system branch: $BRANCH"
            exit 0
          fi

          if ! echo "$BRANCH" | grep -Eq '^(feature|fix|build)/'; then
            echo "Branch naming policy failed for branch: $BRANCH"
            echo "Expected prefix: feature/, fix/, or build/."
            exit 1
          fi

  preview-deploy:
    name: Preview Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Preview deploy placeholder
        run: |
          echo "Preview deploy job is enabled as a placeholder."
          echo "Wire your provider hook here (Vercel/Netlify/Render/etc.) to create PR previews."

  core-quality:
    name: Core Quality (Scoped)
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run scoped kernel tests
        run: |
          python -m pytest -q \
            tests/test_manifest_validation.py \
            tests/test_manifest_registry.py \
            tests/test_spawn_context.py \
            tests/test_capability_router.py \
            tests/test_observability.py \
            tests/test_helper1_integration.py \
            tests/test_hologram_reconciler_race.py

      - name: Run scoped mypy strict checks
        run: |
          python -m mypy --strict \
            core/agent_manifest.py \
            core/manifest_registry.py \
            core/spawn_context.py \
            core/capability_router.py \
            core/observability.py \
            backend/app.py

      - name: Run scoped ruff checks
        run: |
          python -m ruff check \
            core/agent_manifest.py \
            core/manifest_registry.py \
            core/spawn_context.py \
            core/capability_router.py \
            core/observability.py \
            backend/app.py \
            tools/constitution_audit.py

  constitution-audit:
    name: Constitution Audit (Advisory)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Run advisory constitution audit
        run: |
          python tools/constitution_audit.py

      - name: Upload constitution advisory artifact
        uses: actions/upload-artifact@v4
        with:
          name: constitution-audit
          path: artifacts/constitution_audit.json
          if-no-files-found: warn

  # Optional deploy job: wire this to your serverless platform
  # (Vercel, Netlify, AWS Lambda via Serverless Framework, etc.)
  #
  # To enable:
  #   - Create a deploy script in tools/deploy_serverless.sh or .ps1
  #   - Add any required secrets in GitHub repo settings
  #   - Uncomment this job and adjust steps for your provider
  #
  # deploy:
  #   needs: test
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #     - name: Check out repository
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.13'
  #
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements-dev.txt
  #
  #     - name: Deploy to serverless
  #       env:
  #         # Example: AWS credentials or other provider secrets
  #         # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         # AWS_REGION: ${{ secrets.AWS_REGION }}
  #         # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         SWARMZ_ENV: production
  #       run: |
  #         bash tools/deploy_serverless.sh
